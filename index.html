// ëª¨ë°”ì¼ í„°ì¹˜ í™˜ê²½ ê°œì„ 
function setupMobileTouchEnhancements() {
    let longPressTimer = null;
    let isDragging = false;
    let selectedEmotion = null;
    
    // ê°ì •ì¹´ë“œì— í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
    function addTouchEvents() {
        const emotionChips = document.querySelectorAll('.emotion-chip');
        
        emotionChips.forEach(chip => {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
            chip.removeEventListener('touchstart', handleTouchStart);
            chip.removeEventListener('touchend', handleTouchEnd);
            chip.removeEventListener('touchmove', handleTouchMove);
            
            // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
            chip.addEventListener('touchstart', handleTouchStart, { passive: false });
            chip.addEventListener('touchend', handleTouchEnd, { passive: false });
            chip.addEventListener('touchmove', handleTouchMove, { passive: false });
        });
    }

    function handleTouchStart(e) {
        const chip = e.currentTarget;
        
        // ê¸¸ê²Œ ëˆ„ë¥´ê¸° ê°ì§€ ì‹œì‘
        longPressTimer = setTimeout(() => {
            showMobileContextMenu(chip, e.touches[0]);
            navigator.vibrate && navigator.vibrate(50); // í–…í‹± í”¼ë“œë°±
        }, 500);
        
        // ì„ íƒ íš¨ê³¼
        chip.classList.add('touch-pressed');
    }

    function handleTouchMove(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }

    function handleTouchEnd(e) {
        const chip = e.currentTarget;
        
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            
            // ì§§ì€ íƒ­ = ì„ íƒ/í•´ì œ
            if (!selectedEmotion) {
                selectEmotionForMove(chip);
            } else if (selectedEmotion === chip) {
                deselectEmotion();
            } else {
                // ë‹¤ë¥¸ ê°ì •ì¹´ë“œ íƒ­ = ìœ„ì¹˜ êµí™˜
                swapEmotions(selectedEmotion, chip);
            }
        }
        
        chip.classList.remove('touch-pressed');
    }

    function selectEmotionForMove(chip) {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.selected-for-move').forEach(el => {
            el.classList.remove('selected-for-move');
        });
        
        selectedEmotion = chip;
        chip.classList.add('selected-for-move');
        
        // 4ë¶„ë©´ë“¤ì„ í•˜ì´ë¼ì´íŠ¸
        document.querySelectorAll('.quadrant').forEach(quadrant => {
            quadrant.classList.add('move-target');
            quadrant.addEventListener('click', handleQuadrantTap);
        });
        
        // ì†ŒìŠ¤ ì˜ì—­ë„ í™œì„±í™”
        const sourceArea = document.getElementById('emotionSource');
        if (sourceArea) {
            sourceArea.classList.add('move-target');
            sourceArea.addEventListener('click', handleSourceTap);
        }
        
        showToast('ì´ë™í•  ìœ„ì¹˜ë¥¼ íƒ­í•˜ì„¸ìš” (ë‹¤ì‹œ íƒ­í•˜ë©´ ì·¨ì†Œ)');
        
        // ìë™ ì·¨ì†Œ (10ì´ˆ í›„)
        setTimeout(() => {
            if (selectedEmotion === chip) {
                deselectEmotion();
            }
        }, 10000);
    }

    function deselectEmotion() {
        if (selectedEmotion) {
            selectedEmotion.classList.remove('selected-for-move');
            selectedEmotion = null;
        }
        
        // ëª¨ë“  íƒ€ê²Ÿ ë¹„í™œì„±í™”
        document.querySelectorAll('.move-target').forEach(target => {
            target.classList.remove('move-target');
            target.removeEventListener('click', handleQuadrantTap);
            target.removeEventListener('click', handleSourceTap);
        });
    }

    function handleQuadrantTap(e) {
        if (!selectedEmotion) return;
        
        e.stopPropagation();
        const quadrant = e.currentTarget.dataset.quadrant;
        const emotionData = selectedEmotion.dataset.emotion || 
                           selectedEmotion.closest('[data-emotion]')?.dataset.emotion;
        
        if (emotionData && quadrant) {
            const emotion = JSON.parse(emotionData);
            moveEmotionToQuadrant(emotion, quadrant);
            deselectEmotion();
        }
    }

    function handleSourceTap(e) {
        if (!selectedEmotion) return;
        
        e.stopPropagation();
        const emotionData = selectedEmotion.dataset.emotion || 
                           selectedEmotion.closest('[data-emotion]')?.dataset.emotion;
        
        if (emotionData) {
            const emotion = JSON.parse(emotionData);
            moveEmotionToSource(emotion);
            deselectEmotion();
        }
    }

    function swapEmotions(chip1, chip2) {
        const emotion1Data = chip1.dataset.emotion || chip1.closest('[data-emotion]')?.dataset.emotion;
        const emotion2Data = chip2.dataset.emotion || chip2.closest('[data-emotion]')?.dataset.emotion;
        
        if (!emotion1Data || !emotion2Data) return;
        
        const emotion1 = JSON.parse(emotion1Data);
        const emotion2 = JSON.parse(emotion2Data);
        
        const location1 = getCurrentEmotionLocation(emotion1);
        const location2 = getCurrentEmotionLocation(emotion2);
        
        // ë‘ ê°ì •ì˜ ìœ„ì¹˜ êµí™˜
        removeEmotionFromAllLocations(emotion1);
        removeEmotionFromAllLocations(emotion2);
        
        if (location1 !== 'source') {
            appState.quadrantEmotions[location1].push(emotion2);
        }
        if (location2 !== 'source') {
            appState.quadrantEmotions[location2].push(emotion1);
        }
        
        showToast(`ê°ì •ì¹´ë“œ ìœ„ì¹˜ê°€ êµí™˜ë˜ì—ˆì–´ìš”!`);
        playSound('success');
        
        renderStep();
        updateUI();
        saveToStorage();
        
        deselectEmotion();
    }

    function showMobileContextMenu(chip, touch) {
        const emotionData = chip.dataset.emotion || chip.closest('[data-emotion]')?.dataset.emotion;
        if (!emotionData) return;
        
        const emotion = JSON.parse(emotionData);
        const menu = createMobileMenu(emotion);
        
        // ê¸°ì¡´ ë©”ë‰´ ì œê±°
        document.querySelectorAll('.mobile-context-menu').forEach(m => m.remove());
        
        // í™”ë©´ ì¤‘ì•™ì— ë©”ë‰´ í‘œì‹œ
        menu.style.position = 'fixed';
        menu.style.top = '50%';
        menu.style.left = '50%';
        menu.style.transform = 'translate(-50%, -50%)';
        
        document.body.appendChild(menu);
        
        // ë°°ê²½ ì˜¤ë²„ë ˆì´ ì¶”ê°€
        const overlay = document.createElement('div');
        overlay.className = 'mobile-menu-overlay fixed inset-0 bg-black bg-opacity-50 z-40';
        overlay.addEventListener('click', () => {
            menu.remove();
            overlay.remove();
        });
        
        document.body.appendChild(overlay);
    }

    function createMobileMenu(emotion) {
        const menu = document.createElement('div');
        menu.className = 'mobile-context-menu fixed bg-white dark:bg-gray-800 rounded-2xl shadow-2xl z-50 p-6 max-w-sm w-full mx-4';
        
        const currentLocation = getCurrentEmotionLocation(emotion);
        
        menu.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">${emotion.emoji}</div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">
                    ${emotion.name[appState.language]}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    ${emotion.description[appState.language]}
                </p>
            </div>
            
            <div class="space-y-3">
                ${currentLocation !== 'source' ? `
                    <button onclick="mobileMenuAction('source', '${encodeURIComponent(JSON.stringify(emotion))}')" 
                            class="w-full py-3 px-4 bg-blue-500 text-white rounded-xl flex items-center justify-center space-x-2 text-sm font-medium">
                        <span>ğŸ”„</span>
                        <span>ë¶„ë¥˜í•¨ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</span>
                    </button>
                ` : ''}
                
                <div class="text-xs text-gray-500 dark:text-gray-400 text-center">ë‹¤ë¥¸ ë¶„ë©´ìœ¼ë¡œ ì´ë™</div>
                
                <div class="grid grid-cols-2 gap-3">
                    ${Object.keys(quadrantInfo).map(quadrant => {
                        if (currentLocation === quadrant) return '';
                        const info = quadrantInfo[quadrant];
                        return `
                            <button onclick="mobileMenuAction('${quadrant}', '${encodeURIComponent(JSON.stringify(emotion))}')" 
                                    class="py-3 px-2 ${info.color} border-2 border-gray-200 rounded-xl text-xs font-medium text-center">
                                <div class="text-lg mb-1">${info.title[appState.language].split(' ')[0]}</div>
                                <div>${info.title[appState.language].split(' ')[1] || ''}</div>
                            </button>
                        `;
                    }).join('')}
                </div>
                
                <button onclick="closeMobileMenu()" 
                        class="w-full py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-xl text-sm font-medium">
                    ì·¨ì†Œ
                </button>
            </div>
        `;
        
        return menu;
    }

    // ì´ˆê¸° ì„¤ì •
    addTouchEvents();
    
    // renderStep í›„ ì¬ì„¤ì •
    const originalRenderStep = window.renderStep || renderStep;
    window.renderStep = function() {
        originalRenderStep();
        setTimeout(addTouchEvents, 100);
    };
}

// ëª¨ë°”ì¼ ë©”ë‰´ ì•¡ì…˜ í•¨ìˆ˜ë“¤
window.mobileMenuAction = function(target, emotionJson) {
    const emotion = JSON.parse(decodeURIComponent(emotionJson));
    
    if (target === 'source') {
        moveEmotionToSource(emotion);
    } else {
        moveEmotionToQuadrant(emotion, target);
    }
    
    closeMobileMenu();
};

window.closeMobileMenu = function() {
    document.querySelectorAll('.mobile-context-menu, .mobile-menu-overlay').forEach(el => el.remove());
};

function moveEmotionToQuadrant(emotion, quadrant) {
    // ëª¨ë“  ìœ„ì¹˜ì—ì„œ ì œê±°
    Object.keys(appState.quadrantEmotions).forEach(key => {
        appState.quadrantEmotions[key] = appState.quadrantEmotions[key].filter(e => 
            (e.name !== emotion.name) && (e.name.ko !== emotion.name.ko)
        );
    });
    
    // ìƒˆ ìœ„ì¹˜ì— ì¶”ê°€
    appState.quadrantEmotions[quadrant].push(emotion);
    
    const quadrantName = quadrantInfo[quadrant].title[appState.language];
    showToast(`"${emotion.name[appState.language]}"ì´(ê°€) ${quadrantName}ë¡œ ì´ë™í–ˆì–´ìš”!`);
    
    renderStep();
    updateUI();
    saveToStorage();
    playSound('success');
}

// ëª¨ë°”ì¼ ì „ìš© CSS ì¶”ê°€
const mobileStyle = document.createElement('style');
mobileStyle.textContent = `
    .touch-pressed {
        transform: scale(0.95);
        opacity: 0.8;
        transition: all 0.1s ease;
    }
    
    .selected-for-move {
        border: 2px solid #3b82f6 !important;
        background: rgba(59, 130, 246, 0.1) !important;
        animation: pulse-select 1.5s infinite;
    }
    
    @keyframes pulse-select {
        0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
    }
    
    .move-target {
        border: 2px dashed #10b981 !important;
        background: rgba(16, 185, 129, 0.1) !important;
        cursor: pointer;
        animation: move-target-pulse 1s infinite;
    }
    
    @keyframes move-target-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .mobile-context-menu {
        animation: mobileMenuSlideUp 0.3s ease-out;
    }
    
    @keyframes mobileMenuSlideUp {
        from { 
            opacity: 0; 
            transform: translate(-50%, -50%) scale(0.9); 
        }
        to { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1); 
        }
    }
    
    /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ í˜¸ë²„ íš¨ê³¼ ë¹„í™œì„±í™” */
    @media (hover: none) {
        .emotion-chip:hover {
            transform: none;
        }
    }
    
    /* í„°ì¹˜ íƒ€ê²Ÿ í¬ê¸° í™•ë³´ */
    @media (max-width: 640px) {
        .emotion-chip {
            min-height: 44px;
            min-width: 44px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .quadrant {
            min-height: 150px;
            padding: 16px;
        }
    }
`;
document.head.appendChild(mobileStyle);
