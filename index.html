<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>감정 4분면 탐색기 - 개선버전</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 80vh;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* 감정 소스 영역 */
        .emotion-source {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* 4분면 그리드 */
        .quadrant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            height: 100%;
        }

        .quadrant {
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .quadrant:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .quadrant.drag-over {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }

        .quadrant-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .quadrant-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .quadrant-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* 4분면 색상 */
        .q1 { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
        .q2 { background: linear-gradient(135deg, #4ecdc4, #6ee6dd); }
        .q3 { background: linear-gradient(135deg, #45b7d1, #6cc3d6); }
        .q4 { background: linear-gradient(135deg, #96ceb4, #a8d5ba); }

        /* 감정 카드 */
        .emotion-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 25px;
            padding: 8px 15px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            min-height: 44px;
            min-width: 44px;
        }

        .emotion-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .emotion-chip.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .emotion-chip.touch-pressed {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .emotion-chip.selected-for-move {
            border: 2px solid #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1) !important;
            animation: pulse-select 1.5s infinite;
        }

        @keyframes pulse-select {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
        }

        .move-target {
            border: 2px dashed #10b981 !important;
            background: rgba(16, 185, 129, 0.1) !important;
            animation: move-target-pulse 1s infinite;
        }

        @keyframes move-target-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 드래그 고스트 이미지 */
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
            transform: rotate(-2deg);
        }

        /* 모바일 메뉴 */
        .mobile-context-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 90vw;
            width: 320px;
            animation: mobileMenuSlideUp 0.3s ease-out;
        }

        @keyframes mobileMenuSlideUp {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 토스트 메시지 */
        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 14px;
            font-weight: 500;
            max-width: 300px;
            animation: fadeInRight 0.3s ease-out;
            pointer-events: none;
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(20px); }
        }

        /* 헤더 */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* 반응형 */
        @media (max-width: 640px) {
            .container {
                padding: 15px;
            }

            .quadrant {
                min-height: 150px;
                padding: 15px;
            }

            .quadrant-title {
                font-size: 16px;
            }

            .emotion-chip {
                font-size: 13px;
                padding: 6px 12px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        /* 드롭 영역 하이라이트 */
        .emotion-source.drag-over {
            background: rgba(255, 255, 255, 1);
            border: 2px dashed #3b82f6;
        }

        /* 감정 추가 버튼 */
        .add-emotion-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 8px 15px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            min-height: 44px;
            min-width: 44px;
        }

        .add-emotion-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* 감정 추가 모달 */
        .add-emotion-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 90vw;
            width: 400px;
            animation: mobileMenuSlideUp 0.3s ease-out;
        }

        .add-emotion-modal h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #374151;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .emoji-input {
            font-size: 2rem;
            text-align: center;
            height: 60px;
        }

        .emoji-suggestions {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .emoji-btn {
            padding: 8px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .emoji-btn:hover, .emoji-btn.selected {
            background: #e0e7ff;
            border-color: #3b82f6;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* 사용자 정의 감정 표시 */
        .custom-emotion {
            position: relative;
        }

        .custom-emotion::after {
            content: '✨';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }

        .delete-emotion-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .custom-emotion:hover .delete-emotion-btn {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🎭 감정 4분면 탐색기</h1>
            <p>감정을 분류하고 이해해보세요</p>
        </div>

        <!-- 메인 그리드 -->
        <div class="main-grid">
            <!-- 감정 소스 영역 -->
            <div class="emotion-source" id="emotionSource">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; color: #374151;">
                    🎯 감정 카드함
                </h2>
                <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
                    아래 감정들을 적절한 분면으로 드래그하거나 터치해보세요
                </p>
                <div class="emotion-container" id="sourceContainer">
                    <!-- 감정 카드들이 여기에 동적으로 추가됩니다 -->
                </div>
                
                <!-- 감정 추가 버튼 -->
                <div class="add-emotion-btn" id="addEmotionBtn">
                    <span>➕</span>
                    <span>새 감정 추가</span>
                </div>
            </div>

            <!-- 4분면 그리드 -->
            <div class="quadrant-grid">
                <div class="quadrant q1" data-quadrant="q1">
                    <div class="quadrant-header">
                        <div class="quadrant-title">😤 고에너지 부정</div>
                        <div class="quadrant-subtitle">분노, 스트레스, 긴장</div>
                    </div>
                    <div class="emotion-container" id="q1-emotions"></div>
                </div>

                <div class="quadrant q2" data-quadrant="q2">
                    <div class="quadrant-header">
                        <div class="quadrant-title">😊 고에너지 긍정</div>
                        <div class="quadrant-subtitle">기쁨, 신남, 활력</div>
                    </div>
                    <div class="emotion-container" id="q2-emotions"></div>
                </div>

                <div class="quadrant q3" data-quadrant="q3">
                    <div class="quadrant-header">
                        <div class="quadrant-title">😔 저에너지 부정</div>
                        <div class="quadrant-subtitle">슬픔, 우울, 무기력</div>
                    </div>
                    <div class="emotion-container" id="q3-emotions"></div>
                </div>

                <div class="quadrant q4" data-quadrant="q4">
                    <div class="quadrant-header">
                        <div class="quadrant-title">😌 저에너지 긍정</div>
                        <div class="quadrant-subtitle">평온, 만족, 안정</div>
                    </div>
                    <div class="emotion-container" id="q4-emotions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 감정 추가 모달 -->
    <div class="add-emotion-modal" id="addEmotionModal" style="display: none;">
        <h3>새로운 감정 추가하기</h3>
        
        <div class="form-group">
            <label for="emotionName">감정 이름</label>
            <input type="text" id="emotionName" placeholder="예: 설렘, 짜증, 뿌듯함..." maxlength="10">
        </div>
        
        <div class="form-group">
            <label for="emotionEmoji">이모지 선택</label>
            <input type="text" id="emotionEmoji" class="emoji-input" placeholder="😊" maxlength="2">
            <div class="emoji-suggestions">
                <div class="emoji-btn" data-emoji="😊">😊</div>
                <div class="emoji-btn" data-emoji="😢">😢</div>
                <div class="emoji-btn" data-emoji="😠">😠</div>
                <div class="emoji-btn" data-emoji="😰">😰</div>
                <div class="emoji-btn" data-emoji="🤩">🤩</div>
                <div class="emoji-btn" data-emoji="😴">😴</div>
                <div class="emoji-btn" data-emoji="🙄">🙄</div>
                <div class="emoji-btn" data-emoji="🤔">🤔</div>
                <div class="emoji-btn" data-emoji="😤">😤</div>
                <div class="emoji-btn" data-emoji="🥰">🥰</div>
                <div class="emoji-btn" data-emoji="😭">😭</div>
                <div class="emoji-btn" data-emoji="😱">😱</div>
                <div class="emoji-btn" data-emoji="🤯">🤯</div>
                <div class="emoji-btn" data-emoji="😵">😵</div>
                <div class="emoji-btn" data-emoji="🤗">🤗</div>
                <div class="emoji-btn" data-emoji="🤪">🤪</div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="emotionDescription">감정 설명</label>
            <textarea id="emotionDescription" rows="2" placeholder="이 감정이 어떤 상태인지 설명해주세요..." maxlength="50"></textarea>
        </div>
        
        <div class="modal-buttons">
            <button type="button" class="btn-secondary" id="cancelAddEmotion">취소</button>
            <button type="button" class="btn-primary" id="saveAddEmotion">추가하기</button>
        </div>
    </div>

    <script>
        // 앱 상태 관리
        let appState = {
            language: 'ko',
            soundEnabled: true,
            quadrantEmotions: {
                q1: [], // 고에너지 부정
                q2: [], // 고에너지 긍정
                q3: [], // 저에너지 부정
                q4: []  // 저에너지 긍정
            },
            customEmotions: [] // 사용자 정의 감정
        };

        // 4분면 정보
        const quadrantInfo = {
            q1: {
                title: { ko: '고에너지 부정', en: 'High Energy Negative' },
                color: 'bg-red-400',
                description: { ko: '분노, 스트레스, 긴장', en: 'Anger, Stress, Tension' }
            },
            q2: {
                title: { ko: '고에너지 긍정', en: 'High Energy Positive' },
                color: 'bg-teal-400',
                description: { ko: '기쁨, 신남, 활력', en: 'Joy, Excitement, Energy' }
            },
            q3: {
                title: { ko: '저에너지 부정', en: 'Low Energy Negative' },
                color: 'bg-blue-400',
                description: { ko: '슬픔, 우울, 무기력', en: 'Sadness, Depression, Lethargy' }
            },
            q4: {
                title: { ko: '저에너지 긍정', en: 'Low Energy Positive' },
                color: 'bg-green-400',
                description: { ko: '평온, 만족, 안정', en: 'Calm, Satisfaction, Stability' }
            }
        };

        // 감정 데이터
        const emotions = [
            { name: { ko: '행복', en: 'Happy' }, emoji: '😊', description: { ko: '기쁘고 즐거운 상태', en: 'Joyful and cheerful state' } },
            { name: { ko: '슬픔', en: 'Sad' }, emoji: '😢', description: { ko: '우울하고 낙담한 기분', en: 'Melancholy and dejected feeling' } },
            { name: { ko: '분노', en: 'Angry' }, emoji: '😠', description: { ko: '화가 나고 격분한 상태', en: 'Furious and irritated state' } },
            { name: { ko: '평온', en: 'Calm' }, emoji: '😌', description: { ko: '마음이 고요하고 안정된 상태', en: 'Peaceful and stable state' } },
            { name: { ko: '신남', en: 'Excited' }, emoji: '🤩', description: { ko: '흥분되고 들뜬 기분', en: 'Thrilled and enthusiastic feeling' } },
            { name: { ko: '피곤', en: 'Tired' }, emoji: '😴', description: { ko: '지치고 무기력한 상태', en: 'Exhausted and weary state' } },
            { name: { ko: '불안', en: 'Anxious' }, emoji: '😰', description: { ko: '걱정되고 초조한 마음', en: 'Worried and restless mind' } },
            { name: { ko: '만족', en: 'Content' }, emoji: '😊', description: { ko: '충족되고 흡족한 기분', en: 'Satisfied and fulfilled feeling' } },
            { name: { ko: '스트레스', en: 'Stressed' }, emoji: '😫', description: { ko: '긴장되고 압박감을 느끼는 상태', en: 'Tense and pressured state' } },
            { name: { ko: '희망', en: 'Hopeful' }, emoji: '🌟', description: { ko: '미래에 대한 긍정적 기대', en: 'Positive expectation for future' } },
            { name: { ko: '외로움', en: 'Lonely' }, emoji: '😔', description: { ko: '혼자라는 느낌의 쓸쓸함', en: 'Solitary and melancholic feeling' } },
            { name: { ko: '감사', en: 'Grateful' }, emoji: '🙏', description: { ko: '고마움을 느끼는 마음', en: 'Thankful and appreciative heart' } }
        ];

        // 디바이스 타입 감지
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // 토스트 메시지 표시
        function showToast(message) {
            // 기존 토스트 제거
            document.querySelectorAll('.custom-toast').forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'fadeOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 2000);
        }

        // 감정 카드 생성
        function createEmotionChip(emotion, isCustom = false) {
            const chip = document.createElement('div');
            chip.className = isCustom ? 'emotion-chip custom-emotion' : 'emotion-chip';
            chip.dataset.emotion = JSON.stringify(emotion);
            chip.dataset.isCustom = isCustom;
            chip.draggable = true; // 드래그 가능 설정

            const emoji = document.createElement('span');
            emoji.textContent = emotion.emoji;

            const name = document.createElement('span');
            name.textContent = emotion.name[appState.language];

            chip.appendChild(emoji);
            chip.appendChild(name);

            // 사용자 정의 감정에는 삭제 버튼 추가
            if (isCustom) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-emotion-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = '감정 삭제';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCustomEmotion(emotion);
                });
                chip.appendChild(deleteBtn);
            }

            // 드래그 이벤트 추가
            addDragEvents(chip);

            return chip;
        }

        // 드래그 이벤트 추가
        function addDragEvents(chip) {
            // 데스크톱 드래그 이벤트
            chip.addEventListener('dragstart', handleDragStart);
            chip.addEventListener('dragend', handleDragEnd);

            // 터치 이벤트는 별도로 처리
            if (isTouchDevice) {
                addTouchEventsToChip(chip);
            }
        }

        // 드래그 시작
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        // 드래그 종료
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');

            // 모든 드래그 오버 효과 제거
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        // 드롭 영역 설정
        function setupDropZones() {
            // 4분면 드롭 영역
            document.querySelectorAll('.quadrant').forEach(quadrant => {
                quadrant.addEventListener('dragover', handleDragOver);
                quadrant.addEventListener('drop', handleDrop);
                quadrant.addEventListener('dragenter', handleDragEnter);
                quadrant.addEventListener('dragleave', handleDragLeave);
            });

            // 소스 영역 드롭 설정
            const sourceArea = document.getElementById('emotionSource');
            sourceArea.addEventListener('dragover', handleDragOver);
            sourceArea.addEventListener('drop', handleDropToSource);
            sourceArea.addEventListener('dragenter', handleDragEnter);
            sourceArea.addEventListener('dragleave', handleDragLeave);
        }

        // 드래그 오버
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // 드래그 엔터
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        // 드래그 리브
        function handleDragLeave(e) {
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        }

        // 드롭 처리
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            this.classList.remove('drag-over');

            if (draggedElement) {
                const emotionData = draggedElement.dataset.emotion;
                if (emotionData) {
                    const emotion = JSON.parse(emotionData);
                    const targetQuadrant = this.dataset.quadrant;

                    if (targetQuadrant) {
                        moveEmotionToQuadrant(emotion, targetQuadrant);
                    }
                }
            }

            return false;
        }

        // 소스로 드롭
        function handleDropToSource(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            this.classList.remove('drag-over');

            if (draggedElement) {
                const emotionData = draggedElement.dataset.emotion;
                if (emotionData) {
                    const emotion = JSON.parse(emotionData);
                    moveEmotionToSource(emotion);
                }
            }

            return false;
        }

        // 모든 감정 가져오기 (기본 + 사용자 정의)
        function getAllEmotions() {
            return [...emotions, ...appState.customEmotions];
        }

        // UI 렌더링
        function renderStep() {
            // 소스 영역 렌더링
            const sourceContainer = document.getElementById('sourceContainer');
            sourceContainer.innerHTML = '';

            // 기본 감정들 추가
            emotions.forEach(emotion => {
                if (!isEmotionInQuadrant(emotion)) {
                    sourceContainer.appendChild(createEmotionChip(emotion, false));
                }
            });

            // 사용자 정의 감정들 추가
            appState.customEmotions.forEach(emotion => {
                if (!isEmotionInQuadrant(emotion)) {
                    sourceContainer.appendChild(createEmotionChip(emotion, true));
                }
            });

            // 각 분면 렌더링
            Object.keys(appState.quadrantEmotions).forEach(quadrant => {
                const container = document.getElementById(`${quadrant}-emotions`);
                container.innerHTML = '';

                appState.quadrantEmotions[quadrant].forEach(emotion => {
                    const isCustom = appState.customEmotions.some(ce => ce.name.ko === emotion.name.ko);
                    container.appendChild(createEmotionChip(emotion, isCustom));
                });
            });

            // 터치 이벤트 재설정
            if (isTouchDevice) {
                setTimeout(() => {
                    addTouchEvents();
                }, 50);
            }
        }

        // 감정이 어느 분면에 있는지 확인
        function isEmotionInQuadrant(emotion) {
            for (const [quadrant, emotions] of Object.entries(appState.quadrantEmotions)) {
                if (emotions.find(e => e.name.ko === emotion.name.ko)) {
                    return true;
                }
            }
            return false;
        }

        // 현재 감정 위치 찾기
        function getCurrentEmotionLocation(emotion) {
            for (const [quadrant, emotions] of Object.entries(appState.quadrantEmotions)) {
                if (emotions.find(e => e.name.ko === emotion.name.ko)) {
                    return quadrant;
                }
            }
            return 'source';
        }

        // 모든 위치에서 감정 제거
        function removeEmotionFromAllLocations(emotion) {
            Object.keys(appState.quadrantEmotions).forEach(key => {
                appState.quadrantEmotions[key] = appState.quadrantEmotions[key].filter(e =>
                    e.name.ko !== emotion.name.ko
                );
            });
        }

        // 감정을 소스로 이동
        function moveEmotionToSource(emotion) {
            removeEmotionFromAllLocations(emotion);
            showToast(`"${emotion.name.ko}"가 카드함으로 돌아갔어요!`);
            renderStep();
            saveToStorage();
        }

        // 감정을 분면으로 이동
        function moveEmotionToQuadrant(emotion, quadrant) {
            removeEmotionFromAllLocations(emotion);
            appState.quadrantEmotions[quadrant].push(emotion);

            const quadrantName = quadrantInfo[quadrant].title[appState.language];
            showToast(`"${emotion.name.ko}"이(가) ${quadrantName}로 이동했어요!`);

            renderStep();
            saveToStorage();
        }

        // 로컬 스토리지에 저장
        function saveToStorage() {
            try {
                localStorage.setItem('emotionQuadrantState', JSON.stringify(appState));
            } catch (error) {
                console.error('저장 실패:', error);
            }
        }

        // 로컬 스토리지에서 로드
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('emotionQuadrantState');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    appState = { ...appState, ...loadedState };
                }
            } catch (error) {
                console.error('로드 실패:', error);
            }
        }

        // 터치 상태 관리
        let touchState = {
            selectedEmotion: null,
            isInitialized: false,
            handlers: new WeakMap()
        };

        // 터치 이벤트 추가 (개별 칩)
        function addTouchEventsToChip(chip) {
            let chipState = {
                longPressTimer: null,
                touchStartTime: 0,
                touchStartPos: null
            };

            chip.addEventListener('touchstart', (e) => {
                e.preventDefault();

                chipState.touchStartTime = Date.now();
                chipState.touchStartPos = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };

                // 길게 누르기 감지
                chipState.longPressTimer = setTimeout(() => {
                    handleLongPress(chip);
                    chipState.longPressTimer = null;
                }, 500);

                chip.classList.add('touch-pressed');
            }, { passive: false });

            chip.addEventListener('touchmove', (e) => {
                if (chipState.longPressTimer && chipState.touchStartPos) {
                    const currentPos = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };

                    const distance = Math.sqrt(
                        Math.pow(currentPos.x - chipState.touchStartPos.x, 2) +
                        Math.pow(currentPos.y - chipState.touchStartPos.y, 2)
                    );

                    if (distance > 10) {
                        clearTimeout(chipState.longPressTimer);
                        chipState.longPressTimer = null;
                    }
                }
            }, { passive: false });

            chip.addEventListener('touchend', (e) => {
                if (chipState.longPressTimer) {
                    clearTimeout(chipState.longPressTimer);
                    chipState.longPressTimer = null;

                    const touchDuration = Date.now() - chipState.touchStartTime;
                    if (touchDuration < 500) {
                        handleShortTap(chip);
                    }
                }

                chip.classList.remove('touch-pressed');
            }, { passive: false });
        }

        // 터치 이벤트 추가
        function addTouchEvents() {
            const emotionChips = document.querySelectorAll('.emotion-chip');

            emotionChips.forEach(chip => {
                // 기존 핸들러 제거
                const existingHandlers = touchState.handlers.get(chip);
                if (existingHandlers) {
                    chip.removeEventListener('touchstart', existingHandlers.start);
                    chip.removeEventListener('touchend', existingHandlers.end);
                    chip.removeEventListener('touchmove', existingHandlers.move);
                }

                // 새 핸들러 생성
                const handlers = createTouchHandlers(chip);
                touchState.handlers.set(chip, handlers);

                // 이벤트 추가
                chip.addEventListener('touchstart', handlers.start, { passive: false });
                chip.addEventListener('touchend', handlers.end, { passive: false });
                chip.addEventListener('touchmove', handlers.move, { passive: false });
            });
        }

        // 터치 핸들러 생성
        function createTouchHandlers(chip) {
            let chipState = {
                longPressTimer: null,
                touchStartTime: 0,
                touchStartPos: null
            };

            return {
                start: function(e) {
                    e.preventDefault();

                    if (chipState.longPressTimer) {
                        clearTimeout(chipState.longPressTimer);
                    }

                    chipState.touchStartTime = Date.now();
                    chipState.touchStartPos = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };

                    // 길게 누르기 감지
                    chipState.longPressTimer = setTimeout(() => {
                        if (chip.isConnected) {
                            handleLongPress(chip);
                        }
                        chipState.longPressTimer = null;
                    }, 500);

                    chip.classList.add('touch-pressed');
                },

                move: function(e) {
                    if (chipState.longPressTimer && chipState.touchStartPos) {
                        const currentPos = {
                            x: e.touches[0]?.clientX || 0,
                            y: e.touches[0]?.clientY || 0
                        };

                        const distance = Math.sqrt(
                            Math.pow(currentPos.x - chipState.touchStartPos.x, 2) +
                            Math.pow(currentPos.y - chipState.touchStartPos.y, 2)
                        );

                        if (distance > 10) {
                            clearTimeout(chipState.longPressTimer);
                            chipState.longPressTimer = null;
                        }
                    }
                },

                end: function(e) {
                    if (chipState.longPressTimer) {
                        clearTimeout(chipState.longPressTimer);
                        chipState.longPressTimer = null;

                        const touchDuration = Date.now() - chipState.touchStartTime;
                        if (touchDuration < 500 && chip.isConnected) {
                            handleShortTap(chip);
                        }
                    }

                    chip.classList.remove('touch-pressed');
                    chipState.touchStartTime = 0;
                    chipState.touchStartPos = null;
                }
            };
        }

        // 짧은 탭 처리
        function handleShortTap(chip) {
            if (!touchState.selectedEmotion) {
                selectEmotionForMove(chip);
            } else if (touchState.selectedEmotion === chip) {
                deselectEmotion();
            } else {
                swapEmotions(touchState.selectedEmotion, chip);
            }
        }

        // 길게 누르기 처리
        function handleLongPress(chip) {
            showMobileContextMenu(chip);

            // 햅틱 피드백
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // 감정 선택
        function selectEmotionForMove(chip) {
            deselectEmotion();

            touchState.selectedEmotion = chip;
            chip.classList.add('selected-for-move');

            activateTargetAreas();
            showToast('이동할 위치를 탭하세요 (다시 탭하면 취소)');

            setTimeout(() => {
                if (touchState.selectedEmotion === chip) {
                    deselectEmotion();
                }
            }, 10000);
        }

        // 타겟 영역 활성화
        function activateTargetAreas() {
            document.querySelectorAll('.quadrant').forEach(quadrant => {
                quadrant.classList.add('move-target');

                if (!quadrant._touchMoveHandler) {
                    quadrant._touchMoveHandler = (e) => handleQuadrantTap(e);
                    quadrant.addEventListener('click', quadrant._touchMoveHandler);
                }
            });

            const sourceArea = document.getElementById('emotionSource');
            if (sourceArea) {
                sourceArea.classList.add('move-target');

                if (!sourceArea._touchMoveHandler) {
                    sourceArea._touchMoveHandler = (e) => handleSourceTap(e);
                    sourceArea.addEventListener('click', sourceArea._touchMoveHandler);
                }
            }
        }

        // 선택 해제
        function deselectEmotion() {
            if (touchState.selectedEmotion) {
                touchState.selectedEmotion.classList.remove('selected-for-move');
                touchState.selectedEmotion = null;
            }

            document.querySelectorAll('.move-target').forEach(target => {
                target.classList.remove('move-target');

                if (target._touchMoveHandler) {
                    target.removeEventListener('click', target._touchMoveHandler);
                    target._touchMoveHandler = null;
                }
            });
        }

        // 분면 탭 처리
        function handleQuadrantTap(e) {
            if (!touchState.selectedEmotion) return;

            e.stopPropagation();
            const quadrant = e.currentTarget.dataset.quadrant;
            const emotionData = touchState.selectedEmotion.dataset.emotion;

            if (emotionData && quadrant) {
                const emotion = JSON.parse(emotionData);
                moveEmotionToQuadrant(emotion, quadrant);
                deselectEmotion();
            }
        }

        // 소스 탭 처리
        function handleSourceTap(e) {
            if (!touchState.selectedEmotion) return;

            e.stopPropagation();
            const emotionData = touchState.selectedEmotion.dataset.emotion;

            if (emotionData) {
                const emotion = JSON.parse(emotionData);
                moveEmotionToSource(emotion);
                deselectEmotion();
            }
        }

        // 감정 위치 교환
        function swapEmotions(chip1, chip2) {
            try {
                const emotion1Data = chip1.dataset.emotion;
                const emotion2Data = chip2.dataset.emotion;

                if (!emotion1Data || !emotion2Data) return;

                const emotion1 = JSON.parse(emotion1Data);
                const emotion2 = JSON.parse(emotion2Data);

                const location1 = getCurrentEmotionLocation(emotion1);
                const location2 = getCurrentEmotionLocation(emotion2);

                removeEmotionFromAllLocations(emotion1);
                removeEmotionFromAllLocations(emotion2);

                if (location1 !== 'source') {
                    appState.quadrantEmotions[location1].push(emotion2);
                }
                if (location2 !== 'source') {
                    appState.quadrantEmotions[location2].push(emotion1);
                }

                showToast('감정카드 위치가 교환되었어요!');
                renderStep();
                saveToStorage();
                deselectEmotion();

            } catch (error) {
                console.error('교환 오류:', error);
                deselectEmotion();
            }
        }

        // 모바일 컨텍스트 메뉴 표시
        function showMobileContextMenu(chip) {
            try {
                const emotionData = chip.dataset.emotion;
                if (!emotionData) return;

                const emotion = JSON.parse(emotionData);
                const menu = createMobileMenu(emotion);

                document.querySelectorAll('.mobile-context-menu, .mobile-menu-overlay').forEach(m => m.remove());

                document.body.appendChild(menu);

                const overlay = createOverlay(() => {
                    menu.remove();
                    overlay.remove();
                });

                document.body.appendChild(overlay);

            } catch (error) {
                console.error('메뉴 표시 오류:', error);
            }
        }

        // 모바일 메뉴 생성
        function createMobileMenu(emotion) {
            const menu = document.createElement('div');
            menu.className = 'mobile-context-menu';

            const currentLocation = getCurrentEmotionLocation(emotion);
            const emotionName = emotion.name[appState.language];
            const emotionDescription = emotion.description[appState.language];

            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">${emotion.emoji}</div>
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #374151; margin-bottom: 5px;">
                        ${emotionName}
                    </h3>
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        ${emotionDescription}
                    </p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${currentLocation !== 'source' ? `
                        <button class="move-to-source-btn" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                            🔄 카드함으로 되돌리기
                        </button>
                    ` : ''}
                    
                    <div style="font-size: 0.75rem; color: #6b7280; text-align: center; margin: 8px 0;">다른 분면으로 이동</div>
                    
                    <div class="quadrant-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- 4분면 버튼들이 여기에 추가됩니다 -->
                    </div>
                    
                    <button class="close-menu-btn" style="width: 100%; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 12px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                        취소
                    </button>
                </div>
            `;

            setupMenuEventListeners(menu, emotion, currentLocation);

            return menu;
        }

        // 메뉴 이벤트 리스너 설정
        function setupMenuEventListeners(menu, emotion, currentLocation) {
            // 분류함으로 되돌리기 버튼
            const sourceBtn = menu.querySelector('.move-to-source-btn');
            if (sourceBtn) {
                sourceBtn.addEventListener('click', () => {
                    moveEmotionToSource(emotion);
                    closeAllMenus();
                });
            }

            // 4분면 버튼들 추가
            const quadrantContainer = menu.querySelector('.quadrant-buttons');
            Object.keys(quadrantInfo).forEach(quadrant => {
                if (currentLocation === quadrant) return;

                const info = quadrantInfo[quadrant];
                const titleParts = info.title[appState.language].split(' ');

                const button = document.createElement('button');
                button.style.cssText = `
                    padding: 12px 8px;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    font-size: 0.75rem;
                    font-weight: 500;
                    text-align: center;
                    cursor: pointer;
                    background: ${getQuadrantColor(quadrant)};
                    color: white;
                `;
                button.innerHTML = `
                    <div style="font-size: 1rem; margin-bottom: 4px;">${titleParts[0] || ''}</div>
                    <div>${titleParts[1] || ''}</div>
                `;

                button.addEventListener('click', () => {
                    moveEmotionToQuadrant(emotion, quadrant);
                    closeAllMenus();
                });

                quadrantContainer.appendChild(button);
            });

            // 취소 버튼
            const closeBtn = menu.querySelector('.close-menu-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeAllMenus);
            }
        }

        // 분면 색상 반환
        function getQuadrantColor(quadrant) {
            const colors = {
                q1: '#ff6b6b',
                q2: '#4ecdc4',
                q3: '#45b7d1',
                q4: '#96ceb4'
            };
            return colors[quadrant] || '#6b7280';
        }

        // 오버레이 생성
        function createOverlay(onClick) {
            const overlay = document.createElement('div');
            overlay.className = 'mobile-menu-overlay';
            overlay.addEventListener('click', onClick);
            return overlay;
        }

        // 모든 메뉴 닫기
        function closeAllMenus() {
            document.querySelectorAll('.mobile-context-menu, .mobile-menu-overlay').forEach(el => el.remove());
        }

        // 감정 추가 모달 열기
        function openAddEmotionModal() {
            const modal = document.getElementById('addEmotionModal');
            const overlay = createOverlay(() => closeAddEmotionModal());
            
            modal.style.display = 'block';
            document.body.appendChild(overlay);
            
            // 입력 필드 초기화
            document.getElementById('emotionName').value = '';
            document.getElementById('emotionEmoji').value = '';
            document.getElementById('emotionDescription').value = '';
            
            // 이모지 선택 초기화
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 첫 번째 입력 필드에 포커스
            setTimeout(() => {
                document.getElementById('emotionName').focus();
            }, 100);
        }

        // 감정 추가 모달 닫기
        function closeAddEmotionModal() {
            const modal = document.getElementById('addEmotionModal');
            const overlay = document.querySelector('.mobile-menu-overlay');
            
            modal.style.display = 'none';
            if (overlay) overlay.remove();
        }

        // 새로운 감정 추가
        function addCustomEmotion() {
            const name = document.getElementById('emotionName').value.trim();
            const emoji = document.getElementById('emotionEmoji').value.trim();
            const description = document.getElementById('emotionDescription').value.trim();
            
            // 입력 검증
            if (!name) {
                showToast('감정 이름을 입력해주세요!');
                return;
            }
            
            if (!emoji) {
                showToast('이모지를 선택해주세요!');
                return;
            }
            
            if (!description) {
                showToast('감정 설명을 입력해주세요!');
                return;
            }
            
            // 중복 검사
            const allEmotions = getAllEmotions();
            if (allEmotions.some(e => e.name.ko === name)) {
                showToast('이미 존재하는 감정 이름입니다!');
                return;
            }
            
            // 새 감정 객체 생성
            const newEmotion = {
                name: { ko: name, en: name },
                emoji: emoji,
                description: { ko: description, en: description }
            };
            
            // 사용자 정의 감정 배열에 추가
            appState.customEmotions.push(newEmotion);
            
            showToast(`"${name}" 감정이 추가되었어요! ✨`);
            
            // 저장 및 렌더링
            saveToStorage();
            renderStep();
            closeAddEmotionModal();
        }

        // 사용자 정의 감정 삭제
        function deleteCustomEmotion(emotion) {
            if (!confirm(`"${emotion.name.ko}" 감정을 삭제하시겠습니까?`)) {
                return;
            }
            
            // 분면에서 제거
            removeEmotionFromAllLocations(emotion);
            
            // 사용자 정의 감정 배열에서 제거
            appState.customEmotions = appState.customEmotions.filter(e => 
                e.name.ko !== emotion.name.ko
            );
            
            showToast(`"${emotion.name.ko}" 감정이 삭제되었어요!`);
            
            // 저장 및 렌더링
            saveToStorage();
            renderStep();
        }

        // 이모지 선택 처리
        function setupEmojiSelection() {
            const emojiInput = document.getElementById('emotionEmoji');
            
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 기존 선택 해제
                    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    
                    // 새 선택 표시
                    btn.classList.add('selected');
                    
                    // 입력 필드에 이모지 설정
                    emojiInput.value = btn.dataset.emoji;
                });
            });
        }

        // 초기화
        function init() {
            loadFromStorage();
            renderStep();
            setupDropZones();
            touchState.isInitialized = true;

            console.log('Emotion 4-Quadrant Explorer 초기화 완료!');
            console.log('Touch device:', isTouchDevice);
        }

        // 앱 시작
        window.addEventListener('DOMContentLoaded', init);

        // 전역 함수 등록 (기존 코드와의 호환성을 위해)
        window.appState = appState;
        window.quadrantInfo = quadrantInfo;
        window.getCurrentEmotionLocation = getCurrentEmotionLocation;
        window.removeEmotionFromAllLocations = removeEmotionFromAllLocations;
        window.moveEmotionToSource = moveEmotionToSource;
        window.showToast = showToast;
        window.renderStep = renderStep;
        window.saveToStorage = saveToStorage;
    </script>
</body>
</html>
