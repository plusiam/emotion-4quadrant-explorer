<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ===========================================
           CSS Variables & Theme System
        =========================================== */
        :root {
            --bg-primary: #dbeafe;
            --bg-secondary: #faf5ff;
            --bg-tertiary: #fce7f3;
            --text-primary: #111827;
            --text-secondary: #374151;
        }

        [data-theme="dark"] {
            --bg-primary: #1e3a8a;
            --bg-secondary: #4c1d95;
            --bg-tertiary: #831843;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
        }

        /* ===========================================
           Base Styles
        =========================================== */
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            min-height: 100dvh;
            transition: background 0.3s ease;
        }

        /* ===========================================
           Layout & Components
        =========================================== */
        .accessibility-toolbar {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            display: flex;
            gap: 0.5rem;
        }

        .toolbar-btn {
            padding: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] .toolbar-btn {
            background: #374151;
            color: white;
        }

        .toolbar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15);
        }

        /* ===========================================
           Animations
        =========================================== */
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(2deg); }
            50% { transform: scale(1) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(2deg); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .slide-in { animation: slideIn 0.4s ease-out; }
        .celebrate { animation: celebration 0.6s ease-in-out; }
        .bounce { animation: bounce 2s infinite; }
        .pulse { animation: pulse 2s infinite; }

        /* ===========================================
           Emotion Cards
        =========================================== */
        .emotion-card {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: 2px solid transparent;
        }

        .emotion-card:hover {
            transform: scale(1.05);
        }

        .emotion-card.selected {
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }

        /* ===========================================
           Quadrant System
        =========================================== */
        .quadrant {
            min-height: 120px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            position: relative;
        }

        .quadrant.drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .emotion-chip {
            display: inline-block;
            margin: 4px;
            padding: 6px 12px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .emotion-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .emotion-chip.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        /* ===========================================
           Modal & Overlay
        =========================================== */
        .modal-overlay {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            animation: slideInModal 0.3s ease-out;
        }

        @keyframes slideInModal {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===========================================
           Voice Input
        =========================================== */
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            touch-action: manipulation;
        }

        .voice-btn.listening {
            border-color: #ef4444;
            background: #fef2f2;
            animation: pulse-recording 1.5s infinite;
        }

        @keyframes pulse-recording {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* ===========================================
           Responsive Design
        =========================================== */
        @media (max-width: 640px) {
            .accessibility-toolbar {
                top: 0.5rem;
                right: 0.5rem;
                gap: 0.25rem;
            }
            
            .toolbar-btn {
                min-width: 2rem;
                height: 2rem;
                font-size: 0.75rem;
            }

            input, textarea {
                font-size: 16px !important;
            }
        }

        /* ===========================================
           Print Styles
        =========================================== */
        @media print {
            .no-print { display: none !important; }
            .gradient-bg { background: white !important; }
            body { color: black !important; }
        }

        /* ===========================================
           Font Size Classes
        =========================================== */
        .font-small { font-size: 14px !important; }
        .font-normal { font-size: 16px !important; }
        .font-large { font-size: 18px !important; }
        .font-xlarge { font-size: 20px !important; }

        /* ===========================================
           Swipe Indicators
        =========================================== */
        .swipe-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.5;
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body class="gradient-bg transition-colors duration-300" data-theme="light">
    <!-- ===========================================
         Accessibility Toolbar
    =========================================== -->
    <div class="accessibility-toolbar no-print">
        <button id="refreshBtn" class="toolbar-btn" aria-label="ìƒˆë¡œê³ ì¹¨" title="ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘">
            ğŸ”„
        </button>
        <button id="themeToggle" class="toolbar-btn" aria-label="í…Œë§ˆ ë³€ê²½" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
            <span class="theme-icon">ğŸŒ™</span>
        </button>
        <button id="fontIncrease" class="toolbar-btn" aria-label="ê¸€ì í¬ê¸° í¬ê²Œ" title="ê¸€ì í¬ê¸° ì¦ê°€">
            A+
        </button>
        <button id="fontDecrease" class="toolbar-btn" aria-label="ê¸€ì í¬ê¸° ì‘ê²Œ" title="ê¸€ì í¬ê¸° ê°ì†Œ">
            A-
        </button>
        <button id="soundToggle" class="toolbar-btn" aria-label="ì‚¬ìš´ë“œ í† ê¸€" title="ì‚¬ìš´ë“œ ì¼œê¸°/ë„ê¸°">
            <span class="sound-icon">ğŸ”Š</span>
        </button>
    </div>

    <!-- ===========================================
         Main Application Container
    =========================================== -->
    <div class="min-h-screen flex flex-col">
        <div class="flex-1 p-2 sm:p-4">
            <div class="max-w-6xl mx-auto h-full flex flex-col">
                
                <!-- ===========================================
                     Header Section
                =========================================== -->
                <header class="text-center mb-4 sm:mb-6">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-blue-200 mb-2">
                        ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plus
                    </h1>
                    <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-3">
                        ë‚´ ë§ˆìŒì„ 4ê°€ì§€ë¡œ ë‚˜ëˆ„ì–´ íƒí—˜í•´ë³´ì! ğŸ­
                    </p>
                    <button id="historyBtn" class="text-gray-700 hover:text-gray-900 dark:text-blue-400 text-sm underline transition-colors">
                        ğŸ“Š ë‚˜ì˜ ê°ì • íˆìŠ¤í† ë¦¬ ë³´ê¸°
                    </button>
                </header>

                <!-- ===========================================
                     Progress Bar Section
                =========================================== -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 shadow-md no-print">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs sm:text-sm font-medium text-gray-800 dark:text-gray-300">
                            ì§„í–‰ ìƒí™©
                        </span>
                        <div class="flex items-center gap-2">
                            <span id="saveIndicator" class="text-xs text-green-600 hidden animate-pulse">
                                âœ“ ìë™ ì €ì¥ë¨
                            </span>
                            <span id="progressText" class="text-xs sm:text-sm font-medium text-gray-800 dark:text-gray-300">
                                1/4
                            </span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 sm:h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 sm:h-3 rounded-full transition-all duration-500" style="width: 25%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <span id="stepTitle" class="text-sm sm:text-lg font-medium text-gray-900 dark:text-gray-200">
                            ê°ì • ì¹´ë“œ íƒí—˜í•˜ê¸°
                        </span>
                    </div>
                </div>

                <!-- ===========================================
                     Main Content Area
                =========================================== -->
                <main class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 md:p-8 shadow-lg flex-1 min-h-0 relative">
                    <div id="stepContent" class="h-full overflow-y-auto">
                        <!-- ë™ì  ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <!-- ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° -->
                    <div class="swipe-indicator no-print">
                        â† ìŠ¤ì™€ì´í”„í•˜ì—¬ ì´ë™ â†’
                    </div>
                </main>

                <!-- ===========================================
                     Navigation Section
                =========================================== -->
                <nav class="flex justify-between items-center mt-4 sm:mt-6 no-print px-2" role="navigation">
                    <button id="prevBtn" class="flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-gray-200 text-gray-400 cursor-not-allowed touch-action-manipulation min-h-[44px]" disabled>
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        <span class="text-sm sm:text-base">ì´ì „</span>
                    </button>

                    <div class="flex gap-2">
                        <button id="imageBtn" class="px-4 py-2 text-purple-600 hover:text-purple-800 dark:text-purple-400 transition-colors text-sm sm:text-base">
                            ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥
                        </button>
                        <button id="pdfBtn" class="px-4 py-2 text-green-600 hover:text-green-800 dark:text-green-400 transition-colors text-sm sm:text-base">
                            ğŸ“„ PDF ì €ì¥
                        </button>
                    </div>

                    <button id="nextBtn" class="flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-gray-200 text-gray-400 cursor-not-allowed touch-action-manipulation min-h-[44px]" disabled>
                        <span class="text-sm sm:text-base">ë‹¤ìŒ</span>
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 ml-1 sm:ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </nav>

                <!-- Help Message -->
                <div id="helpMessage" class="text-center mt-2 sm:mt-4 hidden px-2">
                    <p class="text-orange-700 bg-orange-50 dark:bg-orange-900 dark:text-orange-200 px-3 sm:px-4 py-2 rounded-lg inline-block text-sm">
                        ğŸ’¡ ì„ íƒì„ ì™„ë£Œí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ê°ˆ ìˆ˜ ìˆì–´ìš”
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===========================================
         History Modal
    =========================================== -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50">
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">ğŸ“Š ë‚˜ì˜ ê°ì • íˆìŠ¤í† ë¦¬</h2>
                    <button id="closeHistory" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="historyContent">
                    <div id="noHistoryMessage" class="text-center py-8 text-gray-600 dark:text-gray-400">
                        <div class="text-4xl mb-4">ğŸ“ˆ</div>
                        <p>ì•„ì§ ì €ì¥ëœ ê°ì • ê¸°ë¡ì´ ì—†ì–´ìš”.</p>
                        <p class="text-sm mt-2">ê°ì • íƒí—˜ì„ ì™„ë£Œí•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ ìŒ“ì—¬ìš”!</p>
                    </div>
                    
                    <div id="historyChart" class="hidden">
                        <canvas id="emotionChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div id="historyList" class="mt-6">
                        <!-- íˆìŠ¤í† ë¦¬ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button id="exportData" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                        ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button id="clearHistory" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        ğŸ—‘ï¸ íˆìŠ¤í† ë¦¬ ì§€ìš°ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===========================================
         Loading Overlay
    =========================================== -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-800 dark:text-gray-300">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <script>
        // ===========================================
        // Global State Management
        // ===========================================
        const appState = {
            currentStep: 0,
            studentName: '',
            selectedEmotions: [],
            quadrantEmotions: {
                positive_high: [],
                positive_low: [],
                negative_high: [],
                negative_low: []
            },
            personalStory: '',
            reflection: '',
            
            // UI Settings
            soundEnabled: true,
            fontSize: 'normal',
            theme: 'light',
            
            // Data Management
            history: [],
            lastSaved: null
        };

        // ===========================================
        // Emotion Data
        // ===========================================
        const emotionCards = [
            // ê¸ì • + ë†’ì€ ì—ë„ˆì§€ (ì‹ ë‚˜ëŠ” ê°ì •)
            { emoji: 'ğŸ˜Š', name: 'ê¸°ë»ìš”', energy: 'high', valence: 'positive', color: 'bg-yellow-200', description: 'ì‹ ë‚˜ê³  ì¦ê±°ìš´ ë§ˆìŒ' },
            { emoji: 'ğŸ¥³', name: 'ì‹ ë‚˜ìš”', energy: 'high', valence: 'positive', color: 'bg-yellow-200', description: 'íŒŒí‹°í•˜ê³  ì‹¶ì€ ë§ˆìŒ' },
            { emoji: 'ğŸ˜†', name: 'ì›ƒê²¨ìš”', energy: 'high', valence: 'positive', color: 'bg-yellow-200', description: 'ë°°ê¼½ ë¹ ì§€ê²Œ ì›ƒê¸´ ë§ˆìŒ' },
            { emoji: 'ğŸ¤©', name: 'ê°íƒ„í•´ìš”', energy: 'high', valence: 'positive', color: 'bg-yellow-200', description: 'ì™€! ëŒ€ë‹¨í•œ ë§ˆìŒ' },
            { emoji: 'ğŸ¤—', name: 'ë°˜ê°€ì›Œìš”', energy: 'high', valence: 'positive', color: 'bg-yellow-200', description: 'ë§Œë‚˜ì„œ ë°˜ê°€ìš´ ë§ˆìŒ' },
            
            // ê¸ì • + ë‚®ì€ ì—ë„ˆì§€ (í‰ì˜¨í•œ ê°ì •)
            { emoji: 'ğŸ˜Œ', name: 'í¸ì•ˆí•´ìš”', energy: 'low', valence: 'positive', color: 'bg-green-200', description: 'ë§ˆìŒì´ í‰ì˜¨í•œ ìƒíƒœ' },
            { emoji: 'ğŸ¥°', name: 'ì‚¬ë‘í•´ìš”', energy: 'low', valence: 'positive', color: 'bg-pink-200', description: 'ë”°ëœ»í•˜ê³  í¬ê·¼í•œ ë§ˆìŒ' },
            { emoji: 'ğŸ˜´', name: 'í‰í™”ë¡œì›Œìš”', energy: 'low', valence: 'positive', color: 'bg-green-200', description: 'ì•„ë¬´ ê±±ì • ì—†ëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ¤«', name: 'ì¡°ìš©í•´ìš”', energy: 'low', valence: 'positive', color: 'bg-green-200', description: 'ê³ ìš”í•˜ê³  ì¹¨ë¬µí•˜ëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ¤”', name: 'ê¶ê¸ˆí•´ìš”', energy: 'low', valence: 'positive', color: 'bg-indigo-200', description: 'ì•Œê³  ì‹¶ì€ ë§ˆìŒ' },
            
            // ë¶€ì • + ë†’ì€ ì—ë„ˆì§€ (ê²©í•œ ê°ì •)
            { emoji: 'ğŸ˜ ', name: 'í™”ë‚˜ìš”', energy: 'high', valence: 'negative', color: 'bg-red-200', description: 'ì†ìƒí•˜ê³  ì—´ë°›ëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ˜¤', name: 'ë‹µë‹µí•´ìš”', energy: 'high', valence: 'negative', color: 'bg-red-200', description: 'ë§‰ë§‰í•˜ê³  ìˆ¨ ë§‰íˆëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ¤¯', name: 'ì§œì¦ë‚˜ìš”', energy: 'high', valence: 'negative', color: 'bg-red-200', description: 'ì°¸ì„ ìˆ˜ ì—†ì´ ê±°ìŠ¬ë¦¬ëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ˜¡', name: 'ë¹¡ì³ìš”', energy: 'high', valence: 'negative', color: 'bg-red-200', description: 'ì •ë§ ì •ë§ í™”ë‚˜ëŠ” ë§ˆìŒ' },
            { emoji: 'ğŸ˜³', name: 'ë‹¹í™©í•´ìš”', energy: 'high', valence: 'negative', color: 'bg-pink-200', description: 'ì–´ì©” ì¤„ ëª¨ë¥´ëŠ” ë§ˆìŒ' },
            
            // ë¶€ì • + ë‚®ì€ ì—ë„ˆì§€ (ê°€ë¼ì•‰ì€ ê°ì •)
            { emoji: 'ğŸ˜¢', name: 'ìŠ¬í¼ìš”', energy: 'low', valence: 'negative', color: 'bg-blue-200', description: 'ëˆˆë¬¼ì´ ë‚  ê²ƒ ê°™ì€ ë§ˆìŒ' },
            { emoji: 'ğŸ˜°', name: 'ê±±ì •ë¼ìš”', energy: 'low', valence: 'negative', color: 'bg-gray-200', description: 'ë¶ˆì•ˆí•˜ê³  ë¬´ì„œìš´ ë§ˆìŒ' },
            { emoji: 'ğŸ˜”', name: 'ìš°ìš¸í•´ìš”', energy: 'low', valence: 'negative', color: 'bg-blue-200', description: 'ì¶• ì²˜ì§€ê³  ìš°ìš¸í•œ ë§ˆìŒ' },
            { emoji: 'ğŸ˜Ÿ', name: 'ì°ì°í•´ìš”', energy: 'low', valence: 'negative', color: 'bg-gray-200', description: 'ë­”ê°€ ì´ìƒí•˜ê³  ì°ì°í•œ ë§ˆìŒ' },
            { emoji: 'ğŸ˜µâ€ğŸ’«', name: 'í—·ê°ˆë ¤ìš”', energy: 'low', valence: 'negative', color: 'bg-purple-200', description: 'ë¨¸ë¦¬ê°€ ë³µì¡í•œ ë§ˆìŒ' }
        ];

        const steps = [
            'ê°ì • ì¹´ë“œ íƒí—˜í•˜ê¸°',
            'ë‚´ ë§ˆìŒ ê°ì • ê³ ë¥´ê¸°',
            'ê°ì • 4ë¶„ë©´ ë§Œë“¤ê¸°',
            'ë‚˜ë§Œì˜ ê°ì • ì´ì•¼ê¸°'
        ];

        const quadrantInfo = {
            positive_high: { title: 'âš¡ ì‹ ë‚˜ëŠ” ê°ì •', description: 'ì¢‹ê³  í™œë°œí•œ', color: 'bg-yellow-50 border-yellow-200', position: 'ìš°ìƒë‹¨' },
            positive_low: { title: 'ğŸŒ± í‰ì˜¨í•œ ê°ì •', description: 'ì¢‹ê³  ì°¨ë¶„í•œ', color: 'bg-green-50 border-green-200', position: 'ìš°í•˜ë‹¨' },
            negative_high: { title: 'ğŸ”¥ ê²©í•œ ê°ì •', description: 'í˜ë“¤ê³  í™œë°œí•œ', color: 'bg-red-50 border-red-200', position: 'ì¢Œìƒë‹¨' },
            negative_low: { title: 'ğŸ’§ ê°€ë¼ì•‰ì€ ê°ì •', description: 'í˜ë“¤ê³  ì°¨ë¶„í•œ', color: 'bg-blue-50 border-blue-200', position: 'ì¢Œí•˜ë‹¨' }
        };

        // ===========================================
        // Sound System
        // ===========================================
        const sounds = {
            click: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBkuPzvLTgjMGHm7A7+OZURE'),
            success: new Audio('data:audio/wav;base64,UklGRqgEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYQEAACBfnx6eHZ0cm9ta2llYV1ZVU9LRUA7Ni8pIhsUDAQA+/Ps5N7Y0svFwLu2sq6qpqOgnpyamJeVlJOTk5SWl5qbnJ+io6mrr7K2ur7CxcnNztHT1dfY2NnZ2dfW1NPQzcrGwb25s62nm5+Rkot/fXZuZ'),
            error: new Audio('data:audio/wav;base64,UklGRhQJAABXQVZFZm10IBAAAAABAAEIQB8AAIAfAAABAAgAZGF0YfAIAAA')
        };

        // ===========================================
        // Storage Management
        // ===========================================
        const STORAGE_KEY = 'emotionExplorerPlus';

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(appState, data);
                    
                    // Apply loaded settings
                    applyTheme(appState.theme);
                    applyFontSize(appState.fontSize);
                    updateSoundToggle();
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function saveToStorage() {
            try {
                appState.lastSaved = new Date().toISOString();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                showSaveIndicator();
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.remove('hidden');
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 2000);
        }

        // ===========================================
        // Reset/Refresh Functionality
        // ===========================================
        function resetApp() {
            if (confirm('ğŸ”„ ì •ë§ë¡œ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?\n\ní˜„ì¬ ì§„í–‰ ìƒí™©ì´ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.\n(ê°ì • íˆìŠ¤í† ë¦¬ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
                // í˜„ì¬ ì§„í–‰ ìƒí™©ë§Œ ì´ˆê¸°í™” (íˆìŠ¤í† ë¦¬ëŠ” ìœ ì§€)
                const historyBackup = [...appState.history];
                const settingsBackup = {
                    soundEnabled: appState.soundEnabled,
                    fontSize: appState.fontSize,
                    theme: appState.theme
                };

                // ì•± ìƒíƒœ ì´ˆê¸°í™”
                Object.assign(appState, {
                    currentStep: 0,
                    studentName: '',
                    selectedEmotions: [],
                    quadrantEmotions: {
                        positive_high: [],
                        positive_low: [],
                        negative_high: [],
                        negative_low: []
                    },
                    personalStory: '',
                    reflection: '',
                    history: historyBackup,
                    ...settingsBackup,
                    lastSaved: null
                });

                // UI ì—…ë°ì´íŠ¸
                updateUI();
                renderStep();
                saveToStorage();
                
                playSound('success');
                
                // ì„±ê³µ ë©”ì‹œì§€
                setTimeout(() => {
                    alert('âœ¨ ìƒˆë¡­ê²Œ ì‹œì‘í•©ë‹ˆë‹¤! ê°ì • íƒí—˜ì„ ë‹¤ì‹œ í•´ë³´ì„¸ìš”.');
                }, 100);
            }
        }

        // ===========================================
        // Theme & Accessibility
        // ===========================================
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const themeIcon = document.querySelector('.theme-icon');
            themeIcon.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        function applyFontSize(size) {
            const sizeClasses = ['font-small', 'font-normal', 'font-large', 'font-xlarge'];
            sizeClasses.forEach(cls => document.body.classList.remove(cls));
            document.body.classList.add(`font-${size}`);
        }

        function updateSoundToggle() {
            const soundIcon = document.querySelector('.sound-icon');
            soundIcon.textContent = appState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        function playSound(type) {
            if (appState.soundEnabled && sounds[type]) {
                sounds[type].play().catch(() => {});
            }
        }

        // ===========================================
        // Speech Recognition
        // ===========================================
        let speechRecognition = null;
        let currentVoiceInput = null;
        let isVoiceSupported = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = false;
                speechRecognition.interimResults = true;
                speechRecognition.lang = 'ko-KR';
                speechRecognition.maxAlternatives = 1;
                isVoiceSupported = true;
            }
        }

        function startVoiceInput(inputElement, voiceBtn) {
            if (!speechRecognition || currentVoiceInput) return;
            
            currentVoiceInput = inputElement;
            const originalText = inputElement.value;
            
            voiceBtn.classList.add('listening');
            voiceBtn.innerHTML = 'ğŸ™ï¸';
            
            speechRecognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                
                if (transcript) {
                    const newText = originalText ? originalText + ' ' + transcript : transcript;
                    inputElement.value = newText;
                    inputElement.dispatchEvent(new Event('input'));
                }
            };
            
            speechRecognition.onerror = (event) => {
                stopVoiceInput(voiceBtn);
                playSound('error');
                alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            };
            
            speechRecognition.onend = () => {
                stopVoiceInput(voiceBtn);
            };
            
            try {
                speechRecognition.start();
            } catch (error) {
                stopVoiceInput(voiceBtn);
                playSound('error');
                alert('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function stopVoiceInput(voiceBtn) {
            if (speechRecognition) {
                speechRecognition.stop();
            }
            
            currentVoiceInput = null;
            voiceBtn.classList.remove('listening');
            voiceBtn.innerHTML = 'ğŸ¤';
        }

        function createVoiceButton(inputElement) {
            if (!isVoiceSupported) return null;
            
            const voiceBtn = document.createElement('button');
            voiceBtn.className = 'voice-btn';
            voiceBtn.innerHTML = 'ğŸ¤';
            voiceBtn.type = 'button';
            voiceBtn.title = 'ìŒì„±ìœ¼ë¡œ ì…ë ¥í•˜ê¸°';
            voiceBtn.setAttribute('aria-label', 'ìŒì„± ì…ë ¥');
            
            voiceBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (currentVoiceInput && currentVoiceInput === inputElement) {
                    stopVoiceInput(voiceBtn);
                } else {
                    startVoiceInput(inputElement, voiceBtn);
                }
            });
            
            return voiceBtn;
        }

        // ===========================================
        // Touch & Swipe Support
        // ===========================================
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchEndX - touchStartX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0 && appState.currentStep > 0) {
                    prevStep();
                } else if (diff < 0 && canProceed() && appState.currentStep < 3) {
                    nextStep();
                }
            }
        }

        // ===========================================
        // Data Export & History
        // ===========================================
        function saveEmotionHistory() {
            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                studentName: appState.studentName,
                emotions: [...appState.selectedEmotions],
                quadrants: JSON.parse(JSON.stringify(appState.quadrantEmotions)),
                story: appState.personalStory,
                timestamp: new Date().toLocaleString('ko-KR')
            };

            appState.history.push(entry);
            
            // Keep only last 30 entries for performance
            if (appState.history.length > 30) {
                appState.history = appState.history.slice(-30);
            }

            saveToStorage();
        }

        function drawEmotionChart() {
            const canvas = document.getElementById('emotionChart');
            if (!canvas || appState.history.length === 0) return;

            const ctx = canvas.getContext('2d');
            
            // Prepare data
            const labels = appState.history.slice(-10).map(entry => {
                const date = new Date(entry.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const emotionCounts = appState.history.slice(-10).map(entry => entry.emotions.length);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì„ íƒí•œ ê°ì • ê°œìˆ˜',
                        data: emotionCounts,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20,
                            title: {
                                display: true,
                                text: 'ê°ì • ê°œìˆ˜'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ'
                            }
                        }
                    }
                }
            });
        }

        function renderHistoryList() {
            const historyList = document.getElementById('historyList');
            const noHistoryMessage = document.getElementById('noHistoryMessage');
            const historyChart = document.getElementById('historyChart');

            if (appState.history.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                historyChart.classList.add('hidden');
                historyList.innerHTML = '';
                return;
            }

            noHistoryMessage.classList.add('hidden');
            historyChart.classList.remove('hidden');

            const historyHTML = appState.history.slice().reverse().map(entry => `
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-900 dark:text-gray-200">${entry.timestamp}</h3>
                        <button onclick="deleteHistoryEntry(${entry.id})" class="text-red-500 hover:text-red-700 text-sm">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-2">
                        ${entry.emotions.map(emotion => `
                            <span class="px-2 py-1 ${emotion.color} rounded-full text-xs">
                                ${emotion.emoji} ${emotion.name}
                            </span>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 truncate">
                        ${entry.story}
                    </p>
                </div>
            `).join('');

            historyList.innerHTML = historyHTML;
            drawEmotionChart();
        }

        function deleteHistoryEntry(id) {
            appState.history = appState.history.filter(entry => entry.id !== id);
            saveToStorage();
            renderHistoryList();
        }

        function exportHistoryData() {
            const dataStr = JSON.stringify(appState.history, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ê°ì •íˆìŠ¤í† ë¦¬_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        function clearHistory() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ê°ì • íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ì–´ìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                appState.history = [];
                saveToStorage();
                renderHistoryList();
                playSound('success');
            }
        }

        // ===========================================
        // Image Download Functionality
        // ===========================================
        async function downloadImage() {
            try {
                showLoading(true);
                
                // ì¸ì‡„ìš© ì½˜í…ì¸  ìƒì„±
                const printContent = createPrintableContent();
                document.body.appendChild(printContent);
                
                // html2canvasë¡œ ì´ë¯¸ì§€ ë³€í™˜
                const canvas = await html2canvas(printContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800,
                    height: 1200,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // ì„ì‹œ ìš”ì†Œ ì œê±°
                document.body.removeChild(printContent);
                
                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.download = `ê°ì •4ë¶„ë©´_${appState.studentName || 'íƒí—˜ê°€'}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                playSound('success');
                showLoading(false);
                
            } catch (error) {
                console.error('Image download error:', error);
                playSound('error');
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                showLoading(false);
            }
        }

        // ===========================================
        // PDF Generation
        // ===========================================
        async function generatePDF() {
            try {
                showLoading(true);
                
                // ì¸ì‡„ìš© ì½˜í…ì¸  ìƒì„±
                const printContent = createPrintableContent();
                document.body.appendChild(printContent);
                
                // html2canvasë¡œ ì´ë¯¸ì§€ ë³€í™˜
                const canvas = await html2canvas(printContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800,
                    height: 1200,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // ì„ì‹œ ìš”ì†Œ ì œê±°
                document.body.removeChild(printContent);
                
                // PDF ìƒì„±
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // í˜ì´ì§€ í¬ê¸°ì— ë§ê²Œ ì¡°ì •
                if (imgHeight > 280) {
                    const ratio = 280 / imgHeight;
                    doc.addImage(imgData, 'PNG', 10, 10, imgWidth * ratio, 280);
                } else {
                    doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                }
                
                // íŒŒì¼ ì €ì¥
                doc.save(`ê°ì •4ë¶„ë©´_${appState.studentName || 'íƒí—˜ê°€'}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '-')}.pdf`);
                
                playSound('success');
                showLoading(false);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                playSound('error');
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                showLoading(false);
            }
        }

        // ì¸ì‡„ìš© ì½˜í…ì¸  ìƒì„± í•¨ìˆ˜
        function createPrintableContent() {
            const printDiv = document.createElement('div');
            printDiv.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                width: 800px;
                padding: 50px;
                background: white;
                font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
                font-size: 14px;
                line-height: 1.6;
                color: #333;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                border-radius: 12px;
            `;
            
            // ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ HTMLë¡œ êµ¬ì„±
            const emotionsText = appState.selectedEmotions.map(e => `${e.emoji} ${e.name}`).join(', ');
            
            let quadrantHTML = '';
            ['negative_high', 'positive_high', 'negative_low', 'positive_low'].forEach(quadrant => {
                const emotions = appState.quadrantEmotions[quadrant];
                if (emotions.length > 0) {
                    quadrantHTML += `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #4f46e5; margin-bottom: 12px; font-size: 18px; font-weight: bold;">
                                ${quadrantInfo[quadrant].title} (${quadrantInfo[quadrant].position})
                            </h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${emotions.map(emotion => `
                                    <span style="
                                        background: #f8fafc; 
                                        border: 2px solid #e2e8f0; 
                                        padding: 8px 16px; 
                                        border-radius: 16px; 
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: inline-block;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    ">
                                        ${emotion.emoji} ${emotion.name}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            printDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #e2e8f0;">
                    <h1 style="color: #1e40af; font-size: 32px; margin-bottom: 12px; font-weight: bold;">ğŸ­ ë‚˜ì˜ ê°ì • 4ë¶„ë©´ ê²°ê³¼</h1>
                    <p style="color: #64748b; font-size: 18px; margin: 8px 0;">ğŸ“… ${new Date().toLocaleDateString('ko-KR')}</p>
                    ${appState.studentName ? `<p style="color: #64748b; font-size: 18px; margin: 8px 0;">ğŸ‘¤ ${appState.studentName}</p>` : ''}
                </div>
                
                <div style="margin-bottom: 35px;">
                    <h2 style="color: #059669; font-size: 22px; margin-bottom: 18px; font-weight: bold; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">âœ¨</span> ì„ íƒí•œ ê°ì •ë“¤
                    </h2>
                    <div style="background: linear-gradient(135deg, #f0fdf4, #ecfdf5); padding: 20px; border-radius: 12px; border-left: 5px solid #059669; font-size: 16px; font-weight: 500;">
                        ${emotionsText}
                    </div>
                </div>
                
                <div style="margin-bottom: 35px;">
                    <h2 style="color: #7c3aed; font-size: 22px; margin-bottom: 18px; font-weight: bold; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">ğŸ“Š</span> ê°ì • 4ë¶„ë©´ ë¶„ë¥˜
                    </h2>
                    <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); padding: 25px; border-radius: 12px; border-left: 5px solid #7c3aed;">
                        ${quadrantHTML}
                    </div>
                </div>
                
                ${appState.personalStory.trim() ? `
                    <div>
                        <h2 style="color: #dc2626; font-size: 22px; margin-bottom: 18px; font-weight: bold; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">ğŸ“–</span> ë‚˜ì˜ ê°ì • ì´ì•¼ê¸°
                        </h2>
                        <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 25px; border-radius: 12px; border-left: 5px solid #dc2626; white-space: pre-wrap; font-size: 15px; line-height: 1.8;">
                            ${appState.personalStory}
                        </div>
                    </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <p style="color: #94a3b8; font-size: 14px;">ğŸ­ ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plusë¡œ ì œì‘</p>
                </div>
            `;
            
            return printDiv;
        }

        // ===========================================
        // Core App Logic
        // ===========================================
        function canProceed() {
            switch (appState.currentStep) {
                case 0: return true;
                case 1: return appState.selectedEmotions.length > 0;
                case 2: return Object.values(appState.quadrantEmotions).some(arr => arr.length > 0);
                case 3: return appState.personalStory.trim() !== '';
                default: return true;
            }
        }

        function updateUI() {
            const progress = ((appState.currentStep + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${appState.currentStep + 1}/${steps.length}`;
            document.getElementById('stepTitle').textContent = steps[appState.currentStep];

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const helpMessage = document.getElementById('helpMessage');

            // Previous button
            prevBtn.disabled = appState.currentStep === 0;
            prevBtn.className = appState.currentStep === 0
                ? "flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-gray-200 text-gray-400 cursor-not-allowed touch-action-manipulation min-h-[44px]"
                : "flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-blue-500 text-white hover:bg-blue-600 touch-action-manipulation min-h-[44px]";

            // Next button
            const canProceedValue = canProceed();
            nextBtn.disabled = appState.currentStep === steps.length - 1 || !canProceedValue;
            nextBtn.className = appState.currentStep === steps.length - 1 || !canProceedValue
                ? "flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-gray-200 text-gray-400 cursor-not-allowed touch-action-manipulation min-h-[44px]"
                : "flex items-center px-3 sm:px-4 md:px-6 py-2 sm:py-3 rounded-xl font-medium transition-all duration-200 bg-blue-500 text-white hover:bg-blue-600 touch-action-manipulation min-h-[44px]";

            // Help message
            helpMessage.className = !canProceedValue && appState.currentStep < steps.length - 1
                ? "text-center mt-2 sm:mt-4 px-2"
                : "text-center mt-2 sm:mt-4 hidden px-2";
        }

        function nextStep() {
            if (appState.currentStep < steps.length - 1 && canProceed()) {
                playSound('click');
                appState.currentStep++;
                updateUI();
                renderStep();
                saveToStorage();

                // Save to history when completing the journey
                if (appState.currentStep === steps.length - 1 && appState.personalStory.trim()) {
                    saveEmotionHistory();
                    playSound('success');
                }
            }
        }

        function prevStep() {
            if (appState.currentStep > 0) {
                playSound('click');
                appState.currentStep--;
                updateUI();
                renderStep();
            }
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // ===========================================
        // Step Rendering
        // ===========================================
        function renderStep() {
            const stepContent = document.getElementById('stepContent');
            stepContent.classList.remove('slide-in');
            
            let content = '';

            switch (appState.currentStep) {
                case 0: // Introduction
                    content = `
                        <div class="text-center space-y-6">
                            <div class="text-6xl mb-4 bounce">ğŸ­</div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-blue-400 mb-4">
                                ê°ì • ì¹´ë“œ íƒí—˜ì„ ì‹œì‘í•´ìš”!
                            </h2>
                            <div class="max-w-2xl mx-auto">
                                <p class="text-lg text-gray-800 dark:text-gray-300 mb-6">
                                    ì˜¤ëŠ˜ì€ ì—¬ëŸ¬ë¶„ì˜ ë§ˆìŒ ì†ì— ìˆëŠ” ë‹¤ì–‘í•œ ê°ì •ë“¤ì„ íƒí—˜í•´ë³¼ ê±°ì˜ˆìš”! ğŸš€
                                </p>
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border border-blue-200 dark:border-blue-700">
                                    <h3 class="text-xl font-bold text-blue-700 dark:text-blue-300 mb-4">ğŸ—ºï¸ íƒí—˜ ê³„íš</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                                            <div class="text-3xl mb-2">ğŸ´</div>
                                            <h4 class="font-bold text-gray-700 dark:text-blue-400">1. ê°ì • ì¹´ë“œ êµ¬ê²½</h4>
                                            <p class="text-sm text-gray-700 dark:text-gray-400">20ê°€ì§€ ê°ì • ì¹´ë“œë¥¼ ë‘˜ëŸ¬ë³´ë©° ì–´ë–¤ ê°ì •ë“¤ì´ ìˆëŠ”ì§€ ì•Œì•„ë´ìš”</p>
                                        </div>
                                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                                            <div class="text-3xl mb-2">â¤ï¸</div>
                                            <h4 class="font-bold text-gray-700 dark:text-blue-400">2. ë‚´ ê°ì • ê³ ë¥´ê¸°</h4>
                                            <p class="text-sm text-gray-700 dark:text-gray-400">ì§€ê¸ˆ ë‚´ ë§ˆìŒì— ìˆëŠ” ê°ì •ë“¤ì„ ê³¨ë¼ë´ìš”</p>
                                        </div>
                                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                                            <div class="text-3xl mb-2">ğŸ“Š</div>
                                            <h4 class="font-bold text-gray-700 dark:text-blue-400">3. 4ë¶„ë©´ ë§Œë“¤ê¸°</h4>
                                            <p class="text-sm text-gray-700 dark:text-gray-400">ê°ì •ì„ 4ê°€ì§€ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì •ë¦¬í•´ë´ìš”</p>
                                        </div>
                                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                                            <div class="text-3xl mb-2">ğŸ“–</div>
                                            <h4 class="font-bold text-gray-700 dark:text-blue-400">4. ê°ì • ì´ì•¼ê¸°</h4>
                                            <p class="text-sm text-gray-700 dark:text-gray-400">ë‚´ê°€ ê³ ë¥¸ ê°ì •ë“¤ë¡œ ë‚˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë´ìš”</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700 mt-6">
                                    <p class="text-yellow-800 dark:text-yellow-200">
                                        ğŸ’¡ <strong>ê¸°ì–µí•˜ì„¸ìš”!</strong> "ì°ì°í•¨"ë„ ê°ì •ì´ì—ìš”! ì—¬ëŸ¬ë¶„ì´ ëŠë¼ëŠ” ëª¨ë“  ê²ƒì´ ì†Œì¤‘í•œ ê°ì •ì´ëë‹ˆë‹¤.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 1: // Emotion Selection
                    content = `
                        <div class="space-y-6">
                            <div class="text-center">
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-blue-400 mb-4">
                                    ğŸ´ ë‚´ ë§ˆìŒì— ë§ëŠ” ê°ì • ê³ ë¥´ê¸°
                                </h2>
                                <p class="text-gray-800 dark:text-gray-300 mb-6">
                                    ì•„ë˜ ê°ì • ì¹´ë“œë“¤ì„ ì‚´í´ë³´ê³ , ì§€ê¸ˆ ë‚´ ë§ˆìŒì— ìˆëŠ” ê°ì •ë“¤ì„ ê³¨ë¼ì£¼ì„¸ìš”!<br>
                                    <span class="text-gray-700 dark:text-blue-400 font-semibold">ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•´ë„ ê´œì°®ì•„ìš” âœ¨</span>
                                </p>
                            </div>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                ${emotionCards.map(emotion => {
                                    const isSelected = appState.selectedEmotions.find(e => e.name === emotion.name);
                                    return `
                                        <div
                                            data-emotion='${JSON.stringify(emotion)}'
                                            class="emotion-card p-3 sm:p-4 rounded-xl border-2 transition-all cursor-pointer ${
                                                isSelected
                                                    ? `${emotion.color} border-blue-400 selected`
                                                    : 'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:border-blue-200 dark:hover:border-blue-500'
                                            }"
                                            role="button"
                                            tabindex="0"
                                            aria-pressed="${isSelected ? 'true' : 'false'}"
                                            aria-label="ê°ì • ì„ íƒ: ${emotion.name}"
                                        >
                                            <div class="text-2xl sm:text-3xl mb-2 text-center">${emotion.emoji}</div>
                                            <div class="text-sm font-medium text-center dark:text-gray-200">${emotion.name}</div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">${emotion.description}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${appState.selectedEmotions.length > 0 ? `
                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-200 dark:border-green-700">
                                    <h3 class="font-bold text-green-700 dark:text-green-300 mb-3">âœ¨ ì„ íƒí•œ ê°ì •ë“¤ (${appState.selectedEmotions.length}ê°œ):</h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${appState.selectedEmotions.map(emotion => `
                                            <span class="px-3 py-1 rounded-full ${emotion.color} text-sm font-medium border">
                                                ${emotion.emoji} ${emotion.name}
                                            </span>
                                        `).join('')}
                                    </div>
                                    <p class="text-sm text-green-600 dark:text-green-400 mt-3">
                                        ğŸ‰ í›Œë¥­í•´ìš”! ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ ê°ì •ë“¤ì„ 4ê°œ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ë³¼ê¹Œìš”?
                                    </p>
                                </div>
                            ` : `
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-700">
                                    <p class="text-blue-800 dark:text-blue-200 text-center">
                                        ğŸ‘† ìœ„ì˜ ê°ì • ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ì§€ê¸ˆ ë‚´ ë§ˆìŒì— ìˆëŠ” ê°ì •ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”!
                                    </p>
                                </div>
                            `}
                        </div>
                    `;
                    break;

                case 2: // Quadrant Organization
                    content = `
                        <div class="space-y-6">
                            <div class="text-center">
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-purple-400 mb-4">
                                    ğŸ“Š ê°ì • 4ë¶„ë©´ ë§Œë“¤ê¸°
                                </h2>
                                <p class="text-gray-800 dark:text-gray-300 mb-6">
                                    ì„ íƒí•œ ê°ì •ë“¤ì„ 4ê°œì˜ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë³¼ê¹Œìš”?<br>
                                    <span class="text-gray-700 dark:text-purple-400 font-semibold">ê°ì • ì¹´ë“œë¥¼ ë“œë˜ê·¸í•´ì„œ ì•Œë§ì€ ì¹¸ì— ë„£ì–´ë³´ì„¸ìš”! ğŸ¯</span>
                                </p>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- ê°ì • ì¹´ë“œ ì†ŒìŠ¤ ì˜ì—­ -->
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                                    <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center">
                                        ğŸ´ ì„ íƒí•œ ê°ì • ì¹´ë“œë“¤
                                        <span class="ml-2 text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                                            ${appState.selectedEmotions.length}ê°œ
                                        </span>
                                    </h3>
                                    <div id="emotionSource" class="min-h-[120px] flex flex-wrap gap-2 p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                                        ${appState.selectedEmotions.filter(emotion => 
                                            !Object.values(appState.quadrantEmotions).flat().find(e => e.name === emotion.name)
                                        ).map(emotion => `
                                            <div
                                                draggable="true"
                                                data-emotion='${JSON.stringify(emotion)}'
                                                class="emotion-chip ${emotion.color} cursor-move select-none border"
                                                title="${emotion.description}"
                                            >
                                                ${emotion.emoji} ${emotion.name}
                                            </div>
                                        `).join('')}
                                        ${appState.selectedEmotions.filter(emotion => 
                                            !Object.values(appState.quadrantEmotions).flat().find(e => e.name === emotion.name)
                                        ).length === 0 ? '<div class="text-gray-500 dark:text-gray-500 text-center w-full py-4">ëª¨ë“  ê°ì •ì´ ë¶„ë¥˜ë˜ì—ˆì–´ìš”! ğŸ‰</div>' : ''}
                                    </div>
                                </div>

                                <!-- 4ë¶„ë©´ ì˜ì—­ -->
                                <div class="space-y-4">
                                    <!-- ì¢Œí‘œê³„ ì„¤ëª… -->
                                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border border-indigo-200 dark:border-indigo-700 text-center">
                                        <h4 class="font-bold text-indigo-700 dark:text-indigo-300 mb-2">ğŸ“Š ê°ì • ì¢Œí‘œê³„</h4>
                                        <div class="text-sm text-indigo-600 dark:text-indigo-400 space-y-1">
                                            <p>â†‘ <strong>ìœ„ìª½:</strong> ì—ë„ˆì§€ ë†’ìŒ (í™œë°œí•œ ê°ì •)</p>
                                            <p>â†’ <strong>ì˜¤ë¥¸ìª½:</strong> ê¸ì •ì  (ì¢‹ì€ ê°ì •)</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 4ë¶„ë©´ ê·¸ë¦¬ë“œ with ì¶• ë¼ë²¨ -->
                                    <div class="relative px-8 pb-8">
                                        <!-- Yì¶• ë¼ë²¨ (ì—ë„ˆì§€) -->
                                        <div class="absolute -left-2 top-1/2 transform -translate-y-1/2 -rotate-90 text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                            í™œë°œí•¨ â†‘
                                        </div>
                                        
                                        <!-- Xì¶• ë¼ë²¨ (ê°ì •) -->
                                        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                            ê¸ì •ì  â†’
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                        ${['negative_high', 'positive_high', 'negative_low', 'positive_low'].map(quadrant => `
                                            <div 
                                                class="quadrant p-4 rounded-xl ${quadrantInfo[quadrant].color} border-2 transition-all duration-300"
                                                data-quadrant="${quadrant}"
                                                role="region"
                                                aria-label="${quadrantInfo[quadrant].title}"
                                            >
                                                <h4 class="font-bold mb-2 text-center text-sm">
                                                    ${quadrantInfo[quadrant].title}
                                                    <span class="text-xs opacity-75">(${quadrantInfo[quadrant].position})</span>
                                                </h4>
                                                <p class="text-xs text-center mb-3 opacity-75">
                                                    ${quadrantInfo[quadrant].description}
                                                </p>
                                                <div class="min-h-[80px] flex flex-wrap gap-1 justify-center">
                                                    ${appState.quadrantEmotions[quadrant].map(emotion => `
                                                        <div class="emotion-chip ${emotion.color} text-xs border">
                                                            ${emotion.emoji} ${emotion.name}
                                                        </div>
                                                    `).join('')}
                                                    ${appState.quadrantEmotions[quadrant].length === 0 ? '<div class="text-gray-500 text-xs text-center w-full py-2">ì—¬ê¸°ì— ê°ì •ì„ ë†“ì•„ì£¼ì„¸ìš”</div>' : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-700">
                                <h4 class="font-bold text-purple-700 dark:text-purple-300 mb-2">ğŸ’¡ ê°ì • ì¢Œí‘œê³„ ì´í•´í•˜ê¸°:</h4>
                                <ul class="text-sm text-purple-600 dark:text-purple-400 space-y-1">
                                    <li>â€¢ <strong>xì¶• (ì¢Œâ†”ìš°):</strong> ì™¼ìª½ì€ í˜ë“  ê°ì •, ì˜¤ë¥¸ìª½ì€ ì¢‹ì€ ê°ì •</li>
                                    <li>â€¢ <strong>yì¶• (ì•„ë˜â†”ìœ„):</strong> ì•„ë˜ìª½ì€ ì¡°ìš©í•œ ê°ì •, ìœ„ìª½ì€ í™œë°œí•œ ê°ì •</li>
                                    <li>â€¢ <strong>ì •ë‹µì€ ì—†ì–´ìš”:</strong> ì—¬ëŸ¬ë¶„ì´ ëŠë¼ëŠ” ëŒ€ë¡œ ë¶„ë¥˜í•˜ë©´ ë©ë‹ˆë‹¤!</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    break;

                case 3: // Personal Story
                    content = `
                        <div class="space-y-6">
                            <div class="text-center">
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-green-400 mb-4">
                                    ğŸ“– ë‚˜ë§Œì˜ ê°ì • ì´ì•¼ê¸°
                                </h2>
                                <p class="text-gray-800 dark:text-gray-300 mb-6">
                                    ë‚´ê°€ ì„ íƒí•˜ê³  ë¶„ë¥˜í•œ ê°ì •ë“¤ë¡œ ë‚˜ë§Œì˜ íŠ¹ë³„í•œ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”! âœ¨
                                </p>
                            </div>

                            <!-- ë‚´ê°€ ë§Œë“  4ë¶„ë©´ ìš”ì•½ -->
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-xl border border-blue-200 dark:border-blue-700">
                                <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">ğŸ¨ ë‚´ê°€ ë§Œë“  ê°ì • 4ë¶„ë©´</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    ${['negative_high', 'positive_high', 'negative_low', 'positive_low'].map(quadrant => {
                                        const emotions = appState.quadrantEmotions[quadrant];
                                        return `
                                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg border">
                                                <h4 class="font-semibold text-sm mb-2 dark:text-gray-200">
                                                    ${quadrantInfo[quadrant].title} 
                                                    <span class="text-xs opacity-75">(${quadrantInfo[quadrant].position})</span>
                                                </h4>
                                                <div class="flex flex-wrap gap-1">
                                                    ${emotions.length > 0 
                                                        ? emotions.map(emotion => `
                                                            <span class="text-xs px-2 py-1 rounded ${emotion.color} border">
                                                                ${emotion.emoji} ${emotion.name}
                                                            </span>
                                                        `).join('')
                                                        : '<span class="text-xs text-gray-500 dark:text-gray-500">ë¹„ì–´ìˆìŒ</span>'
                                                    }
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ -->
                            <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border border-green-200 dark:border-green-700">
                                <h3 class="font-bold text-green-700 dark:text-green-300 mb-3 flex items-center">
                                    âœï¸ ë‚˜ì˜ ê°ì • ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”
                                    ${isVoiceSupported ? '<span class="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded">ğŸ¤ ìŒì„±ì…ë ¥ ê°€ëŠ¥</span>' : ''}
                                </h3>
                                <p class="text-green-600 dark:text-green-400 text-sm mb-4">
                                    ğŸ’­ ì˜ˆì‹œ: "ì €ëŠ” ì˜¤ëŠ˜ ê¸°ë»ìš”ì™€ í¸ì•ˆí•´ìš”ë¥¼ ëŠê¼ˆì–´ìš”. ì™œëƒí•˜ë©´ ê°€ì¡±ê³¼ í•¨ê»˜ ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆê¸° ë•Œë¬¸ì´ì—ìš”..."
                                </p>
                                <div class="flex items-start gap-2">
                                    <textarea
                                        id="personalStoryInput"
                                        placeholder="ë‚´ê°€ ì„ íƒí•œ ê°ì •ë“¤ì´ ì–¸ì œ, ì™œ ìƒê²¼ëŠ”ì§€ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”...

â€¢ ì–´ë–¤ ìƒí™©ì—ì„œ ì´ëŸ° ê°ì •ì„ ëŠê¼ˆë‚˜ìš”?
â€¢ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?
â€¢ ì´ ê°ì •ë“¤ì„ ë¶„ë¥˜í•´ë³´ë‹ˆ ì–´ë–¤ ìƒê°ì´ ë“œë‚˜ìš”?"
                                        class="flex-1 h-40 p-4 border-2 border-green-200 dark:border-green-600 dark:bg-gray-800 dark:text-gray-200 rounded-lg focus:border-green-400 dark:focus:border-green-500 outline-none resize-none text-base transition-colors"
                                        style="font-size: 16px;"
                                    >${appState.personalStory}</textarea>
                                    <div id="voiceButtonContainer"></div>
                                </div>
                                <p class="text-xs text-green-500 dark:text-green-400 mt-2">
                                    ğŸ’­ ê°ì •ì—ëŠ” ì •ë‹µì´ ì—†ì–´ìš”. ì—¬ëŸ¬ë¶„ì´ ëŠë¼ëŠ” ëª¨ë“  ê°ì •ì´ ì†Œì¤‘í•´ìš”!
                                </p>
                            </div>

                            ${appState.personalStory.trim() !== '' ? `
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-700">
                                    <h3 class="font-bold text-yellow-700 dark:text-yellow-300 mb-2 flex items-center">
                                        ğŸŒŸ ì™„ì„±ëœ ë‚˜ì˜ ê°ì • ì´ì•¼ê¸°
                                        <span class="ml-2 text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 px-2 py-1 rounded">ì™„ë£Œ!</span>
                                    </h3>
                                    <div class="text-gray-800 dark:text-gray-300 bg-white dark:bg-gray-800 p-4 rounded border-l-4 border-yellow-400 leading-relaxed">
                                        ${appState.personalStory.replace(/\n/g, '<br>')}
                                    </div>
                                    <p class="text-sm text-yellow-600 dark:text-yellow-400 mt-3">
                                        ğŸ‘ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í–ˆë„¤ìš”! ì´ì œ ì¹œêµ¬ë“¤ê³¼ ë‚˜ëˆ„ê±°ë‚˜ ì €ì¥í•´ë³´ì„¸ìš”.
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    break;
            }

            stepContent.innerHTML = content;
            
            // Apply animation
            setTimeout(() => {
                stepContent.classList.add('slide-in');
                if (appState.currentStep === 3 && appState.personalStory.trim()) {
                    stepContent.classList.add('celebrate');
                }
            }, 10);
            
            attachStepEventListeners();
        }

        // ===========================================
        // Event Listeners for Each Step
        // ===========================================
        function attachStepEventListeners() {
            switch (appState.currentStep) {
                case 1: // Emotion selection
                    const emotionCards = document.querySelectorAll('.emotion-card');
                    emotionCards.forEach(card => {
                        card.addEventListener('click', handleEmotionCardClick);
                        card.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                handleEmotionCardClick.call(card);
                            }
                        });
                    });
                    break;

                case 2: // Quadrant organization
                    setupDragAndDrop();
                    break;

                case 3: // Personal story
                    setupStoryInput();
                    break;
            }
        }

        function handleEmotionCardClick() {
            const emotion = JSON.parse(this.dataset.emotion);
            toggleEmotion(emotion);
            playSound('click');
            renderStep();
            updateUI();
            saveToStorage();
        }

        function toggleEmotion(emotion) {
            const existingIndex = appState.selectedEmotions.findIndex(e => e.name === emotion.name);
            if (existingIndex >= 0) {
                appState.selectedEmotions.splice(existingIndex, 1);
                // Also remove from quadrants if present
                Object.keys(appState.quadrantEmotions).forEach(quadrant => {
                    appState.quadrantEmotions[quadrant] = appState.quadrantEmotions[quadrant].filter(e => e.name !== emotion.name);
                });
            } else {
                appState.selectedEmotions.push(emotion);
            }
        }

        function setupDragAndDrop() {
            const draggableElements = document.querySelectorAll('[draggable="true"]');
            const quadrants = document.querySelectorAll('.quadrant');
            const sourceArea = document.getElementById('emotionSource');

            // Draggable elements
            draggableElements.forEach(element => {
                element.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', element.dataset.emotion);
                    element.classList.add('dragging');
                });

                element.addEventListener('dragend', (e) => {
                    element.classList.remove('dragging');
                });
            });

            // Drop zones (quadrants + source)
            [...quadrants, sourceArea].forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (zone.classList.contains('quadrant')) {
                        zone.classList.add('drag-over');
                    }
                });

                zone.addEventListener('dragleave', (e) => {
                    if (zone.classList.contains('quadrant')) {
                        zone.classList.remove('drag-over');
                    }
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const emotionData = e.dataTransfer.getData('text/plain');
                    const emotion = JSON.parse(emotionData);

                    // Remove from all current locations
                    Object.keys(appState.quadrantEmotions).forEach(key => {
                        appState.quadrantEmotions[key] = appState.quadrantEmotions[key].filter(e => e.name !== emotion.name);
                    });

                    // Add to new location (if it's a quadrant)
                    if (zone.classList.contains('quadrant')) {
                        const quadrantType = zone.dataset.quadrant;
                        appState.quadrantEmotions[quadrantType].push(emotion);
                        zone.classList.remove('drag-over');
                    }

                    playSound('click');
                    renderStep();
                    updateUI();
                    saveToStorage();
                });
            });

            // Touch support for mobile drag and drop
            let draggedElement = null;

            draggableElements.forEach(element => {
                element.addEventListener('touchstart', (e) => {
                    draggedElement = element;
                    element.style.opacity = '0.5';
                });

                element.addEventListener('touchend', (e) => {
                    if (draggedElement) {
                        draggedElement.style.opacity = '1';
                        draggedElement = null;
                    }
                });
            });

            [...quadrants, sourceArea].forEach(zone => {
                zone.addEventListener('touchend', (e) => {
                    if (draggedElement && zone.contains(e.target)) {
                        const emotion = JSON.parse(draggedElement.dataset.emotion);
                        
                        // Remove from all current locations
                        Object.keys(appState.quadrantEmotions).forEach(key => {
                            appState.quadrantEmotions[key] = appState.quadrantEmotions[key].filter(e => e.name !== emotion.name);
                        });

                        // Add to new location (if it's a quadrant)
                        if (zone.classList.contains('quadrant')) {
                            const quadrantType = zone.dataset.quadrant;
                            appState.quadrantEmotions[quadrantType].push(emotion);
                        }

                        playSound('click');
                        renderStep();
                        updateUI();
                        saveToStorage();
                    }
                });
            });
        }

        function setupStoryInput() {
            const storyInput = document.getElementById('personalStoryInput');
            if (storyInput) {
                storyInput.addEventListener('input', (e) => {
                    appState.personalStory = e.target.value;
                    updateUI();
                });

                // Auto-save on input
                storyInput.addEventListener('input', debounce(() => {
                    saveToStorage();
                }, 1000));

                // Voice input support
                if (isVoiceSupported) {
                    const voiceContainer = document.getElementById('voiceButtonContainer');
                    if (voiceContainer) {
                        const voiceBtn = createVoiceButton(storyInput);
                        if (voiceBtn) {
                            voiceContainer.appendChild(voiceBtn);
                        }
                    }
                }

                storyInput.focus();
            }
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===========================================
        // Global Event Listeners
        // ===========================================
        function initEventListeners() {
            // Accessibility toolbar
            document.getElementById('refreshBtn').addEventListener('click', resetApp);
            
            document.getElementById('themeToggle').addEventListener('click', () => {
                appState.theme = appState.theme === 'light' ? 'dark' : 'light';
                applyTheme(appState.theme);
                saveToStorage();
                playSound('click');
            });

            document.getElementById('fontIncrease').addEventListener('click', () => {
                const sizes = ['small', 'normal', 'large', 'xlarge'];
                const currentIndex = sizes.indexOf(appState.fontSize);
                if (currentIndex < sizes.length - 1) {
                    appState.fontSize = sizes[currentIndex + 1];
                    applyFontSize(appState.fontSize);
                    saveToStorage();
                    playSound('click');
                }
            });

            document.getElementById('fontDecrease').addEventListener('click', () => {
                const sizes = ['small', 'normal', 'large', 'xlarge'];
                const currentIndex = sizes.indexOf(appState.fontSize);
                if (currentIndex > 0) {
                    appState.fontSize = sizes[currentIndex - 1];
                    applyFontSize(appState.fontSize);
                    saveToStorage();
                    playSound('click');
                }
            });

            document.getElementById('soundToggle').addEventListener('click', () => {
                appState.soundEnabled = !appState.soundEnabled;
                updateSoundToggle();
                saveToStorage();
                playSound('click');
            });

            // Navigation
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('nextBtn').addEventListener('click', nextStep);

            // Action buttons
            document.getElementById('imageBtn').addEventListener('click', downloadImage);
            document.getElementById('pdfBtn').addEventListener('click', generatePDF);

            // History modal
            document.getElementById('historyBtn').addEventListener('click', () => {
                document.getElementById('historyModal').classList.remove('hidden');
                renderHistoryList();
            });

            document.getElementById('closeHistory').addEventListener('click', () => {
                document.getElementById('historyModal').classList.add('hidden');
            });

            document.getElementById('exportData').addEventListener('click', exportHistoryData);
            document.getElementById('clearHistory').addEventListener('click', clearHistory);

            // Modal backdrop click
            document.getElementById('historyModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('historyModal').classList.add('hidden');
                }
            });

            // Touch/swipe support
            const mainContent = document.getElementById('stepContent');
            mainContent.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            mainContent.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && appState.currentStep > 0) {
                    prevStep();
                } else if (e.key === 'ArrowRight' && canProceed() && appState.currentStep < 3) {
                    nextStep();
                } else if (e.key === 'Escape') {
                    document.getElementById('historyModal').classList.add('hidden');
                }
            });

            // Auto-save interval
            setInterval(saveToStorage, 30000);
        }

        // ===========================================
        // App Initialization
        // ===========================================
        function init() {
            // Initialize speech recognition
            initSpeechRecognition();
            
            // Load saved data
            loadFromStorage();
            
            // Setup UI
            updateUI();
            renderStep();
            
            // Setup event listeners
            initEventListeners();
            
            // Initial save
            saveToStorage();

            console.log('ğŸ­ ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plus ì‹œì‘!');
        }

        // Global functions for inline event handlers
        window.deleteHistoryEntry = deleteHistoryEntry;

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
