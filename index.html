<!DOCTYPE html>
     <html lang="ko">
     <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plus</title>
         <script src="https://cdn.tailwindcss.com"></script>
         <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
         <style>
             :root {
                 --bg-primary: #dbeafe;
                 --bg-secondary: #faf5ff;
                 --bg-tertiary: #fce7f3;
             }

             [data-theme="dark"] {
                 --bg-primary: #1e3a8a;
                 --bg-secondary: #4c1d95;
                 --bg-tertiary: #831843;
             }

             .gradient-bg {
                 background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
                 min-height: 100vh;
                 transition: background 0.3s ease;
             }

             .dark-mode .gradient-bg {
                 background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
             }

             @media print {
                 .no-print { display: none !important; }
             }

             /* ì• ë‹ˆë©”ì´ì…˜ ê°œì„  */
             @keyframes slideIn {
                 from { transform: translateX(-100%); opacity: 0; }
                 to { transform: translateX(0); opacity: 1; }
             }

             @keyframes celebration {
                 0%, 100% { transform: scale(1) rotate(0deg); }
                 25% { transform: scale(1.1) rotate(5deg); }
                 50% { transform: scale(1) rotate(-5deg); }
                 75% { transform: scale(1.1) rotate(5deg); }
             }

             .slide-in { animation: slideIn 0.3s ease-out; }
             .celebrate { animation: celebration 0.5s ease-in-out; }

             /* ì‚¬ìš´ë“œ ë²„íŠ¼ */
             .sound-btn {
                 position: fixed;
                 bottom: 20px;
                 left: 20px;
                 z-index: 100;
             }

             /* ê¸€ì í¬ê¸° ì¡°ì ˆ */
             .font-size-control {
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 z-index: 100;
             }

             /* ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° */
             .swipe-hint {
                 position: absolute;
                 bottom: 10px;
                 left: 50%;
                 transform: translateX(-50%);
                 opacity: 0.5;
             }
         </style>
     </head>
     <body class="min-h-screen gradient-bg transition-colors duration-300" data-theme="light">
         <div class="min-h-screen flex flex-col">
             <!-- ì ‘ê·¼ì„± ë„êµ¬ ëª¨ìŒ -->
             <div class="fixed top-4 right-4 flex gap-2 z-50 no-print">
                 <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
                 <button id="themeToggle" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="í…Œë§ˆ ë³€ê²½">
                     <span class="dark:hidden">ğŸŒ™</span>
                     <span class="hidden dark:inline">â˜€ï¸</span>
                 </button>

                 <!-- ê¸€ì í¬ê¸° ì¡°ì ˆ -->
                 <button id="fontIncrease" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="ê¸€ì í¬ê¸° í¬ê²Œ">
                     A+
                 </button>
                 <button id="fontDecrease" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="ê¸€ì í¬ê¸° ì‘ê²Œ">
                     A-
                 </button>

                 <!-- ì‚¬ìš´ë“œ í† ê¸€ -->
                 <button id="soundToggle" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="ì‚¬ìš´ë“œ ì¼œê¸°/ë„ê¸°">
                     ğŸ”Š
                 </button>
             </div>

             <div class="flex-1 p-2 sm:p-4">
                 <div class="max-w-6xl mx-auto h-full flex flex-col">
                     <!-- Header with History Link -->
                     <header class="text-center mb-4 sm:mb-6">
                         <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-800 dark:text-blue-200 mb-2">
                             ê°ì • 4ë¶„ë©´ íƒí—˜ê°€ Plus
                         </h1>
                         <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300">
                             ë‚´ ë§ˆìŒì„ 4ê°€ì§€ë¡œ ë‚˜ëˆ„ì–´ íƒí—˜í•´ë³´ì!
                         </p>
                         <div class="mt-2">
                             <button id="historyBtn" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                 ğŸ“Š ë‚˜ì˜ ê°ì • íˆìŠ¤í† ë¦¬ ë³´ê¸°
                             </button>
                         </div>
                     </header>

                     <!-- Progress Bar with Save Indicator -->
                     <div class="bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 shadow-md no-print">
                         <div class="flex items-center justify-between mb-2">
                             <span class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300">
                                 ì§„í–‰ ìƒí™©
                             </span>
                             <div class="flex items-center gap-2">
                                 <span id="saveIndicator" class="text-xs text-green-600 hidden">
                                     âœ“ ìë™ ì €ì¥ë¨
                                 </span>
                                 <span id="progressText" class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300">
                                     1/4
                                 </span>
                             </div>
                         </div>
                         <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 sm:h-3">
                             <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 sm:h-3 rounded-full transition-all duration-300" style="width: 25%"></div>
                         </div>
                     </div>

                     <!-- Main Content with Swipe Support -->
                     <main id="mainContent" class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 md:p-8 shadow-lg flex-1 min-h-0 relative">
                         <div id="stepContent" class="h-full overflow-y-auto">
                             <!-- ë™ì  ì½˜í…ì¸  -->
                         </div>

                         <!-- ìŠ¤ì™€ì´í”„ íŒíŠ¸ -->
                         <div class="swipe-hint text-gray-400 text-xs">
                             â† ìŠ¤ì™€ì´í”„í•˜ì—¬ ì´ë™ â†’
                         </div>
                     </main>

                     <!-- Navigation -->
                     <nav class="flex justify-between mt-4 sm:mt-6 no-print px-2">
                         <button id="prevBtn" class="nav-btn">ì´ì „</button>
                         <button id="shareBtn" class="text-blue-600 hover:text-blue-800">
                             ğŸ“¤ ê³µìœ í•˜ê¸°
                         </button>
                         <button id="nextBtn" class="nav-btn">ë‹¤ìŒ</button>
                     </nav>
                 </div>
             </div>
         </div>

         <!-- ê°ì • íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
         <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
             <div class="flex items-center justify-center h-full p-4">
                 <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                     <h2 class="text-2xl font-bold mb-4">ğŸ“Š ë‚˜ì˜ ê°ì • íˆìŠ¤í† ë¦¬</h2>
                     <canvas id="emotionChart" width="400" height="200"></canvas>
                     <div id="historyList" class="mt-4">
                         <!-- íˆìŠ¤í† ë¦¬ ëª©ë¡ -->
                     </div>
                     <button id="closeHistory" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                         ë‹«ê¸°
                     </button>
                     <button id="exportData" class="mt-4 ml-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                         ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                     </button>
                 </div>
             </div>
         </div>

         <script>
             // ì „ì—­ ìƒíƒœ ê´€ë¦¬ (ê¸°ì¡´ + ì¶”ê°€)
             const appState = {
                 currentStep: 0,
                 studentName: '',
                 selectedEmotions: [],
                 quadrantEmotions: {
                     positive_high: [],
                     positive_low: [],
                     negative_high: [],
                     negative_low: []
                 },
                 personalStory: '',
                 reflection: '',
                 // ìƒˆë¡œìš´ ìƒíƒœë“¤
                 soundEnabled: true,
                 fontSize: 'normal',
                 theme: 'light',
                 history: [],
                 customEmotions: []
             };

             // ì‚¬ìš´ë“œ íš¨ê³¼
             const sounds = {
                 click: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBkuPzvLTgjMGHm7A7+OZURE'),
                 success: new Audio('data:audio/wav;base64,UklGRqgEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYQEAACBfnx6eHZ0cm9ta2llYV1ZVU9LRUA7Ni8pIhsUDAQA+/Ps5N7Y0svFwLu2sq6qpqOgnpyamJeVlJOTk5SWl5qbnJ+io6mrr7K2ur7CxcnNztHT1dfY2NnZ2dfW1NPQzcrGwb25s62nm5+Rkot/fXZuZ
     19YUEg/NywjGRAIAPjx6uTe2NPOyMTBvbq3tbOxsbCwsbKztLW2t7i4uLi4t7a1tLKwr62rq6qrr7Gzt7m6u7y9vr+/v7+/vLu5tbKuqqahm5eTi4V')
             };

             // localStorage í‚¤
             const STORAGE_KEY = 'emotionExplorerPlus';

             // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
             function loadFromStorage() {
                 try {
                     const saved = localStorage.getItem(STORAGE_KEY);
                     if (saved) {
                         const data = JSON.parse(saved);
                         Object.assign(appState, data);
                         applyTheme(appState.theme);
                         applyFontSize(appState.fontSize);
                     }
                 } catch (error) {
                     console.error('Failed to load data:', error);
                 }
             }

             // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
             function saveToStorage() {
                 try {
                     localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                     showSaveIndicator();
                 } catch (error) {
                     console.error('Failed to save data:', error);
                 }
             }

             // ì €ì¥ í‘œì‹œ
             function showSaveIndicator() {
                 const indicator = document.getElementById('saveIndicator');
                 indicator.classList.remove('hidden');
                 setTimeout(() => {
                     indicator.classList.add('hidden');
                 }, 2000);
             }

             // í…Œë§ˆ ì ìš©
             function applyTheme(theme) {
                 document.body.setAttribute('data-theme', theme);
                 document.body.classList.toggle('dark', theme === 'dark');
             }

             // ê¸€ì í¬ê¸° ì ìš©
             function applyFontSize(size) {
                 const sizes = {
                     small: '14px',
                     normal: '16px',
                     large: '18px',
                     xlarge: '20px'
                 };
                 document.body.style.fontSize = sizes[size] || sizes.normal;
             }

             // ì‚¬ìš´ë“œ ì¬ìƒ
             function playSound(type) {
                 if (appState.soundEnabled && sounds[type]) {
                     sounds[type].play().catch(() => {});
                 }
             }

             // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì§€ì›
             let touchStartX = 0;
             let touchEndX = 0;

             function handleSwipe() {
                 const swipeThreshold = 50;
                 const diff = touchEndX - touchStartX;

                 if (Math.abs(diff) > swipeThreshold) {
                     if (diff > 0 && appState.currentStep > 0) {
                         prevStep();
                     } else if (diff < 0 && canProceed() && appState.currentStep < 3) {
                         nextStep();
                     }
                 }
             }

             // ê°ì • íˆìŠ¤í† ë¦¬ ì €ì¥
             function saveEmotionHistory() {
                 const entry = {
                     date: new Date().toISOString(),
                     emotions: appState.selectedEmotions,
                     quadrants: appState.quadrantEmotions,
                     story: appState.personalStory
                 };

                 appState.history.push(entry);
                 // ìµœê·¼ 30ê°œë§Œ ìœ ì§€
                 if (appState.history.length > 30) {
                     appState.history = appState.history.slice(-30);
                 }

                 saveToStorage();
             }

             // ê°ì • ì°¨íŠ¸ ê·¸ë¦¬ê¸°
             function drawEmotionChart() {
                 const ctx = document.getElementById('emotionChart').getContext('2d');
                 const dates = appState.history.map(h => new Date(h.date).toLocaleDateString());
                 const emotionCounts = appState.history.map(h => h.emotions.length);

                 new Chart(ctx, {
                     type: 'line',
                     data: {
                         labels: dates,
                         datasets: [{
                             label: 'ê°ì • ê°œìˆ˜',
                             data: emotionCounts,
                             borderColor: 'rgb(75, 192, 192)',
                             tension: 0.1
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false
                     }
                 });
             }

             // PDF ìƒì„±
             async function generatePDF() {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();

                 // ì œëª©
                 doc.setFontSize(20);
                 doc.text('ë‚˜ì˜ ê°ì • 4ë¶„ë©´ ê²°ê³¼', 105, 20, { align: 'center' });

                 // ë‚ ì§œ
                 doc.setFontSize(12);
                 doc.text(`ë‚ ì§œ: ${new Date().toLocaleDateString()}`, 20, 40);

                 // ì„ íƒí•œ ê°ì •ë“¤
                 doc.text('ì„ íƒí•œ ê°ì •ë“¤:', 20, 60);
                 let y = 70;
                 appState.selectedEmotions.forEach(emotion => {
                     doc.text(`- ${emotion.emoji} ${emotion.name}`, 30, y);
                     y += 10;
                 });

                 // ë‚˜ì˜ ì´ì•¼ê¸°
                 doc.text('ë‚˜ì˜ ê°ì • ì´ì•¼ê¸°:', 20, y + 10);
                 doc.setFontSize(10);
                 const lines = doc.splitTextToSize(appState.personalStory, 170);
                 doc.text(lines, 20, y + 20);

                 // ì €ì¥
                 doc.save('ê°ì •4ë¶„ë©´_ê²°ê³¼.pdf');
             }

             // ê³µìœ  ê¸°ëŠ¥
             function shareResult() {
                 const shareData = {
                     title: 'ê°ì • 4ë¶„ë©´ íƒí—˜ ê²°ê³¼',
                     text: `ì˜¤ëŠ˜ì˜ ê°ì •: ${appState.selectedEmotions.map(e => e.name).join(', ')}\n\n${appState.personalStory}`,
                     url: window.location.href
                 };

                 if (navigator.share) {
                     navigator.share(shareData).catch(() => {});
                 } else {
                     // í´ë¦½ë³´ë“œì— ë³µì‚¬
                     navigator.clipboard.writeText(shareData.text).then(() => {
                         alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                     });
                 }
             }

             // ì§„í–‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
             function canProceed() {
                 switch (appState.currentStep) {
                     case 0: return true;
                     case 1: return appState.selectedEmotions.length > 0;
                     case 2: return Object.values(appState.quadrantEmotions).some(arr => arr.length > 0);
                     case 3: return appState.personalStory.trim() !== '';
                     default: return true;
                 }
             }

             // ë‹¨ê³„ ì´ë™
             function nextStep() {
                 if (appState.currentStep < 3 && canProceed()) {
                     playSound('click');
                     appState.currentStep++;
                     updateUI();
                     renderStep();
                     saveToStorage();
                 }
             }

             function prevStep() {
                 if (appState.currentStep > 0) {
                     playSound('click');
                     appState.currentStep--;
                     updateUI();
                     renderStep();
                 }
             }

             // UI ì—…ë°ì´íŠ¸
             function updateUI() {
                 const progress = ((appState.currentStep + 1) / 4) * 100;
                 document.getElementById('progressBar').style.width = `${progress}%`;
                 document.getElementById('progressText').textContent = `${appState.currentStep + 1}/4`;

                 // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                 document.getElementById('prevBtn').disabled = appState.currentStep === 0;
                 document.getElementById('nextBtn').disabled = !canProceed() || appState.currentStep === 3;
             }

             // ë‹¨ê³„ë³„ ë Œë”ë§ (ê¸°ì¡´ ì½”ë“œ í™œìš©)
             function renderStep() {
                 // ê¸°ì¡´ renderStep ë¡œì§ ì‚¬ìš©
                 const content = document.getElementById('stepContent');
                 content.classList.add('slide-in');

                 // ì™„ë£Œ ì‹œ íˆìŠ¤í† ë¦¬ ì €ì¥
                 if (appState.currentStep === 3 && appState.personalStory) {
                     saveEmotionHistory();
                     playSound('success');
                     content.classList.add('celebrate');
                 }
             }

             // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
             function initEventListeners() {
                 // í…Œë§ˆ í† ê¸€
                 document.getElementById('themeToggle').addEventListener('click', () => {
                     appState.theme = appState.theme === 'light' ? 'dark' : 'light';
                     applyTheme(appState.theme);
                     saveToStorage();
                 });

                 // ê¸€ì í¬ê¸°
                 document.getElementById('fontIncrease').addEventListener('click', () => {
                     const sizes = ['small', 'normal', 'large', 'xlarge'];
                     const currentIndex = sizes.indexOf(appState.fontSize);
                     if (currentIndex < sizes.length - 1) {
                         appState.fontSize = sizes[currentIndex + 1];
                         applyFontSize(appState.fontSize);
                         saveToStorage();
                     }
                 });

                 document.getElementById('fontDecrease').addEventListener('click', () => {
                     const sizes = ['small', 'normal', 'large', 'xlarge'];
                     const currentIndex = sizes.indexOf(appState.fontSize);
                     if (currentIndex > 0) {
                         appState.fontSize = sizes[currentIndex - 1];
                         applyFontSize(appState.fontSize);
                         saveToStorage();
                     }
                 });

                 // ì‚¬ìš´ë“œ í† ê¸€
                 document.getElementById('soundToggle').addEventListener('click', (e) => {
                     appState.soundEnabled = !appState.soundEnabled;
                     e.target.textContent = appState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                     saveToStorage();
                 });

                 // íˆìŠ¤í† ë¦¬
                 document.getElementById('historyBtn').addEventListener('click', () => {
                     document.getElementById('historyModal').classList.remove('hidden');
                     if (appState.history.length > 0) {
                         drawEmotionChart();
                     }
                 });

                 document.getElementById('closeHistory').addEventListener('click', () => {
                     document.getElementById('historyModal').classList.add('hidden');
                 });

                 // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                 document.getElementById('exportData').addEventListener('click', () => {
                     const dataStr = JSON.stringify(appState.history, null, 2);
                     const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                     const exportFileDefaultName = `ê°ì •íˆìŠ¤í† ë¦¬_${new Date().toISOString().split('T')[0]}.json`;

                     const linkElement = document.createElement('a');
                     linkElement.setAttribute('href', dataUri);
                     linkElement.setAttribute('download', exportFileDefaultName);
                     linkElement.click();
                 });

                 // ê³µìœ 
                 document.getElementById('shareBtn').addEventListener('click', shareResult);

                 // ë„¤ë¹„ê²Œì´ì…˜
                 document.getElementById('prevBtn').addEventListener('click', prevStep);
                 document.getElementById('nextBtn').addEventListener('click', nextStep);

                 // ìŠ¤ì™€ì´í”„
                 const mainContent = document.getElementById('mainContent');
                 mainContent.addEventListener('touchstart', (e) => {
                     touchStartX = e.changedTouches[0].screenX;
                 });

                 mainContent.addEventListener('touchend', (e) => {
                     touchEndX = e.changedTouches[0].screenX;
                     handleSwipe();
                 });

                 // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'ArrowLeft' && appState.currentStep > 0) {
                         prevStep();
                     } else if (e.key === 'ArrowRight' && canProceed() && appState.currentStep < 3) {
                         nextStep();
                     }
                 });
             }

             // ì´ˆê¸°í™”
             function init() {
                 loadFromStorage();
                 updateUI();
                 renderStep();
                 initEventListeners();

                 // ìë™ ì €ì¥
                 setInterval(saveToStorage, 30000);
             }

             // ì•± ì‹œì‘
             document.addEventListener('DOMContentLoaded', init);
         </script>
     </body>
     </html>
