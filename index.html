<!DOCTYPE html>
     <html lang="ko">
     <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>감정 4분면 탐험가 Plus</title>
         <script src="https://cdn.tailwindcss.com"></script>
         <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
         <style>
             :root {
                 --bg-primary: #dbeafe;
                 --bg-secondary: #faf5ff;
                 --bg-tertiary: #fce7f3;
             }

             [data-theme="dark"] {
                 --bg-primary: #1e3a8a;
                 --bg-secondary: #4c1d95;
                 --bg-tertiary: #831843;
             }

             .gradient-bg {
                 background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
                 min-height: 100vh;
                 transition: background 0.3s ease;
             }

             .dark-mode .gradient-bg {
                 background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
             }

             @media print {
                 .no-print { display: none !important; }
             }

             /* 애니메이션 개선 */
             @keyframes slideIn {
                 from { transform: translateX(-100%); opacity: 0; }
                 to { transform: translateX(0); opacity: 1; }
             }

             @keyframes celebration {
                 0%, 100% { transform: scale(1) rotate(0deg); }
                 25% { transform: scale(1.1) rotate(5deg); }
                 50% { transform: scale(1) rotate(-5deg); }
                 75% { transform: scale(1.1) rotate(5deg); }
             }

             .slide-in { animation: slideIn 0.3s ease-out; }
             .celebrate { animation: celebration 0.5s ease-in-out; }

             /* 사운드 버튼 */
             .sound-btn {
                 position: fixed;
                 bottom: 20px;
                 left: 20px;
                 z-index: 100;
             }

             /* 글자 크기 조절 */
             .font-size-control {
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 z-index: 100;
             }

             /* 스와이프 인디케이터 */
             .swipe-hint {
                 position: absolute;
                 bottom: 10px;
                 left: 50%;
                 transform: translateX(-50%);
                 opacity: 0.5;
             }
         </style>
     </head>
     <body class="min-h-screen gradient-bg transition-colors duration-300" data-theme="light">
         <div class="min-h-screen flex flex-col">
             <!-- 접근성 도구 모음 -->
             <div class="fixed top-4 right-4 flex gap-2 z-50 no-print">
                 <!-- 다크모드 토글 -->
                 <button id="themeToggle" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="테마 변경">
                     <span class="dark:hidden">🌙</span>
                     <span class="hidden dark:inline">☀️</span>
                 </button>

                 <!-- 글자 크기 조절 -->
                 <button id="fontIncrease" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="글자 크기 크게">
                     A+
                 </button>
                 <button id="fontDecrease" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="글자 크기 작게">
                     A-
                 </button>

                 <!-- 사운드 토글 -->
                 <button id="soundToggle" class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg" aria-label="사운드 켜기/끄기">
                     🔊
                 </button>
             </div>

             <div class="flex-1 p-2 sm:p-4">
                 <div class="max-w-6xl mx-auto h-full flex flex-col">
                     <!-- Header with History Link -->
                     <header class="text-center mb-4 sm:mb-6">
                         <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-800 dark:text-blue-200 mb-2">
                             감정 4분면 탐험가 Plus
                         </h1>
                         <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300">
                             내 마음을 4가지로 나누어 탐험해보자!
                         </p>
                         <div class="mt-2">
                             <button id="historyBtn" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                 📊 나의 감정 히스토리 보기
                             </button>
                         </div>
                     </header>

                     <!-- Progress Bar with Save Indicator -->
                     <div class="bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 shadow-md no-print">
                         <div class="flex items-center justify-between mb-2">
                             <span class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300">
                                 진행 상황
                             </span>
                             <div class="flex items-center gap-2">
                                 <span id="saveIndicator" class="text-xs text-green-600 hidden">
                                     ✓ 자동 저장됨
                                 </span>
                                 <span id="progressText" class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300">
                                     1/4
                                 </span>
                             </div>
                         </div>
                         <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 sm:h-3">
                             <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 sm:h-3 rounded-full transition-all duration-300" style="width: 25%"></div>
                         </div>
                     </div>

                     <!-- Main Content with Swipe Support -->
                     <main id="mainContent" class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 md:p-8 shadow-lg flex-1 min-h-0 relative">
                         <div id="stepContent" class="h-full overflow-y-auto">
                             <!-- 동적 콘텐츠 -->
                         </div>

                         <!-- 스와이프 힌트 -->
                         <div class="swipe-hint text-gray-400 text-xs">
                             ← 스와이프하여 이동 →
                         </div>
                     </main>

                     <!-- Navigation -->
                     <nav class="flex justify-between mt-4 sm:mt-6 no-print px-2">
                         <button id="prevBtn" class="nav-btn">이전</button>
                         <button id="shareBtn" class="text-blue-600 hover:text-blue-800">
                             📤 공유하기
                         </button>
                         <button id="nextBtn" class="nav-btn">다음</button>
                     </nav>
                 </div>
             </div>
         </div>

         <!-- 감정 히스토리 모달 -->
         <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
             <div class="flex items-center justify-center h-full p-4">
                 <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                     <h2 class="text-2xl font-bold mb-4">📊 나의 감정 히스토리</h2>
                     <canvas id="emotionChart" width="400" height="200"></canvas>
                     <div id="historyList" class="mt-4">
                         <!-- 히스토리 목록 -->
                     </div>
                     <button id="closeHistory" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                         닫기
                     </button>
                     <button id="exportData" class="mt-4 ml-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                         📥 데이터 내보내기
                     </button>
                 </div>
             </div>
         </div>

         <script>
             // 전역 상태 관리 (기존 + 추가)
             const appState = {
                 currentStep: 0,
                 studentName: '',
                 selectedEmotions: [],
                 quadrantEmotions: {
                     positive_high: [],
                     positive_low: [],
                     negative_high: [],
                     negative_low: []
                 },
                 personalStory: '',
                 reflection: '',
                 // 새로운 상태들
                 soundEnabled: true,
                 fontSize: 'normal',
                 theme: 'light',
                 history: [],
                 customEmotions: []
             };

             // 사운드 효과
             const sounds = {
                 click: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBkuPzvLTgjMGHm7A7+OZURE'),
                 success: new Audio('data:audio/wav;base64,UklGRqgEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYQEAACBfnx6eHZ0cm9ta2llYV1ZVU9LRUA7Ni8pIhsUDAQA+/Ps5N7Y0svFwLu2sq6qpqOgnpyamJeVlJOTk5SWl5qbnJ+io6mrr7K2ur7CxcnNztHT1dfY2NnZ2dfW1NPQzcrGwb25s62nm5+Rkot/fXZuZ
     19YUEg/NywjGRAIAPjx6uTe2NPOyMTBvbq3tbOxsbCwsbKztLW2t7i4uLi4t7a1tLKwr62rq6qrr7Gzt7m6u7y9vr+/v7+/vLu5tbKuqqahm5eTi4V')
             };

             // localStorage 키
             const STORAGE_KEY = 'emotionExplorerPlus';

             // 로컬 스토리지에서 데이터 불러오기
             function loadFromStorage() {
                 try {
                     const saved = localStorage.getItem(STORAGE_KEY);
                     if (saved) {
                         const data = JSON.parse(saved);
                         Object.assign(appState, data);
                         applyTheme(appState.theme);
                         applyFontSize(appState.fontSize);
                     }
                 } catch (error) {
                     console.error('Failed to load data:', error);
                 }
             }

             // 로컬 스토리지에 저장
             function saveToStorage() {
                 try {
                     localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                     showSaveIndicator();
                 } catch (error) {
                     console.error('Failed to save data:', error);
                 }
             }

             // 저장 표시
             function showSaveIndicator() {
                 const indicator = document.getElementById('saveIndicator');
                 indicator.classList.remove('hidden');
                 setTimeout(() => {
                     indicator.classList.add('hidden');
                 }, 2000);
             }

             // 테마 적용
             function applyTheme(theme) {
                 document.body.setAttribute('data-theme', theme);
                 document.body.classList.toggle('dark', theme === 'dark');
             }

             // 글자 크기 적용
             function applyFontSize(size) {
                 const sizes = {
                     small: '14px',
                     normal: '16px',
                     large: '18px',
                     xlarge: '20px'
                 };
                 document.body.style.fontSize = sizes[size] || sizes.normal;
             }

             // 사운드 재생
             function playSound(type) {
                 if (appState.soundEnabled && sounds[type]) {
                     sounds[type].play().catch(() => {});
                 }
             }

             // 스와이프 제스처 지원
             let touchStartX = 0;
             let touchEndX = 0;

             function handleSwipe() {
                 const swipeThreshold = 50;
                 const diff = touchEndX - touchStartX;

                 if (Math.abs(diff) > swipeThreshold) {
                     if (diff > 0 && appState.currentStep > 0) {
                         prevStep();
                     } else if (diff < 0 && canProceed() && appState.currentStep < 3) {
                         nextStep();
                     }
                 }
             }

             // 감정 히스토리 저장
             function saveEmotionHistory() {
                 const entry = {
                     date: new Date().toISOString(),
                     emotions: appState.selectedEmotions,
                     quadrants: appState.quadrantEmotions,
                     story: appState.personalStory
                 };

                 appState.history.push(entry);
                 // 최근 30개만 유지
                 if (appState.history.length > 30) {
                     appState.history = appState.history.slice(-30);
                 }

                 saveToStorage();
             }

             // 감정 차트 그리기
             function drawEmotionChart() {
                 const ctx = document.getElementById('emotionChart').getContext('2d');
                 const dates = appState.history.map(h => new Date(h.date).toLocaleDateString());
                 const emotionCounts = appState.history.map(h => h.emotions.length);

                 new Chart(ctx, {
                     type: 'line',
                     data: {
                         labels: dates,
                         datasets: [{
                             label: '감정 개수',
                             data: emotionCounts,
                             borderColor: 'rgb(75, 192, 192)',
                             tension: 0.1
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false
                     }
                 });
             }

             // PDF 생성
             async function generatePDF() {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();

                 // 제목
                 doc.setFontSize(20);
                 doc.text('나의 감정 4분면 결과', 105, 20, { align: 'center' });

                 // 날짜
                 doc.setFontSize(12);
                 doc.text(`날짜: ${new Date().toLocaleDateString()}`, 20, 40);

                 // 선택한 감정들
                 doc.text('선택한 감정들:', 20, 60);
                 let y = 70;
                 appState.selectedEmotions.forEach(emotion => {
                     doc.text(`- ${emotion.emoji} ${emotion.name}`, 30, y);
                     y += 10;
                 });

                 // 나의 이야기
                 doc.text('나의 감정 이야기:', 20, y + 10);
                 doc.setFontSize(10);
                 const lines = doc.splitTextToSize(appState.personalStory, 170);
                 doc.text(lines, 20, y + 20);

                 // 저장
                 doc.save('감정4분면_결과.pdf');
             }

             // 공유 기능
             function shareResult() {
                 const shareData = {
                     title: '감정 4분면 탐험 결과',
                     text: `오늘의 감정: ${appState.selectedEmotions.map(e => e.name).join(', ')}\n\n${appState.personalStory}`,
                     url: window.location.href
                 };

                 if (navigator.share) {
                     navigator.share(shareData).catch(() => {});
                 } else {
                     // 클립보드에 복사
                     navigator.clipboard.writeText(shareData.text).then(() => {
                         alert('결과가 클립보드에 복사되었습니다!');
                     });
                 }
             }

             // 진행 가능 여부 확인
             function canProceed() {
                 switch (appState.currentStep) {
                     case 0: return true;
                     case 1: return appState.selectedEmotions.length > 0;
                     case 2: return Object.values(appState.quadrantEmotions).some(arr => arr.length > 0);
                     case 3: return appState.personalStory.trim() !== '';
                     default: return true;
                 }
             }

             // 단계 이동
             function nextStep() {
                 if (appState.currentStep < 3 && canProceed()) {
                     playSound('click');
                     appState.currentStep++;
                     updateUI();
                     renderStep();
                     saveToStorage();
                 }
             }

             function prevStep() {
                 if (appState.currentStep > 0) {
                     playSound('click');
                     appState.currentStep--;
                     updateUI();
                     renderStep();
                 }
             }

             // UI 업데이트
             function updateUI() {
                 const progress = ((appState.currentStep + 1) / 4) * 100;
                 document.getElementById('progressBar').style.width = `${progress}%`;
                 document.getElementById('progressText').textContent = `${appState.currentStep + 1}/4`;

                 // 버튼 상태 업데이트
                 document.getElementById('prevBtn').disabled = appState.currentStep === 0;
                 document.getElementById('nextBtn').disabled = !canProceed() || appState.currentStep === 3;
             }

             // 단계별 렌더링 (기존 코드 활용)
             function renderStep() {
                 // 기존 renderStep 로직 사용
                 const content = document.getElementById('stepContent');
                 content.classList.add('slide-in');

                 // 완료 시 히스토리 저장
                 if (appState.currentStep === 3 && appState.personalStory) {
                     saveEmotionHistory();
                     playSound('success');
                     content.classList.add('celebrate');
                 }
             }

             // 이벤트 리스너 등록
             function initEventListeners() {
                 // 테마 토글
                 document.getElementById('themeToggle').addEventListener('click', () => {
                     appState.theme = appState.theme === 'light' ? 'dark' : 'light';
                     applyTheme(appState.theme);
                     saveToStorage();
                 });

                 // 글자 크기
                 document.getElementById('fontIncrease').addEventListener('click', () => {
                     const sizes = ['small', 'normal', 'large', 'xlarge'];
                     const currentIndex = sizes.indexOf(appState.fontSize);
                     if (currentIndex < sizes.length - 1) {
                         appState.fontSize = sizes[currentIndex + 1];
                         applyFontSize(appState.fontSize);
                         saveToStorage();
                     }
                 });

                 document.getElementById('fontDecrease').addEventListener('click', () => {
                     const sizes = ['small', 'normal', 'large', 'xlarge'];
                     const currentIndex = sizes.indexOf(appState.fontSize);
                     if (currentIndex > 0) {
                         appState.fontSize = sizes[currentIndex - 1];
                         applyFontSize(appState.fontSize);
                         saveToStorage();
                     }
                 });

                 // 사운드 토글
                 document.getElementById('soundToggle').addEventListener('click', (e) => {
                     appState.soundEnabled = !appState.soundEnabled;
                     e.target.textContent = appState.soundEnabled ? '🔊' : '🔇';
                     saveToStorage();
                 });

                 // 히스토리
                 document.getElementById('historyBtn').addEventListener('click', () => {
                     document.getElementById('historyModal').classList.remove('hidden');
                     if (appState.history.length > 0) {
                         drawEmotionChart();
                     }
                 });

                 document.getElementById('closeHistory').addEventListener('click', () => {
                     document.getElementById('historyModal').classList.add('hidden');
                 });

                 // 데이터 내보내기
                 document.getElementById('exportData').addEventListener('click', () => {
                     const dataStr = JSON.stringify(appState.history, null, 2);
                     const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                     const exportFileDefaultName = `감정히스토리_${new Date().toISOString().split('T')[0]}.json`;

                     const linkElement = document.createElement('a');
                     linkElement.setAttribute('href', dataUri);
                     linkElement.setAttribute('download', exportFileDefaultName);
                     linkElement.click();
                 });

                 // 공유
                 document.getElementById('shareBtn').addEventListener('click', shareResult);

                 // 네비게이션
                 document.getElementById('prevBtn').addEventListener('click', prevStep);
                 document.getElementById('nextBtn').addEventListener('click', nextStep);

                 // 스와이프
                 const mainContent = document.getElementById('mainContent');
                 mainContent.addEventListener('touchstart', (e) => {
                     touchStartX = e.changedTouches[0].screenX;
                 });

                 mainContent.addEventListener('touchend', (e) => {
                     touchEndX = e.changedTouches[0].screenX;
                     handleSwipe();
                 });

                 // 키보드 네비게이션
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'ArrowLeft' && appState.currentStep > 0) {
                         prevStep();
                     } else if (e.key === 'ArrowRight' && canProceed() && appState.currentStep < 3) {
                         nextStep();
                     }
                 });
             }

             // 초기화
             function init() {
                 loadFromStorage();
                 updateUI();
                 renderStep();
                 initEventListeners();

                 // 자동 저장
                 setInterval(saveToStorage, 30000);
             }

             // 앱 시작
             document.addEventListener('DOMContentLoaded', init);
         </script>
     </body>
     </html>
