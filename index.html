// ÏµúÏ¢Ö ÏôÑÏÑ±Îêú Î™®Î∞îÏùº ÌÑ∞Ïπò ÌôòÍ≤Ω Í∞úÏÑ† ÏΩîÎìú
(function() {
    'use strict';
    
    // Ï†ÑÏó≠ ÏÉÅÌÉú Í¥ÄÎ¶¨
    let touchState = {
        longPressTimer: null,
        selectedEmotion: null,
        isInitialized: false,
        handlers: new WeakMap()
    };
    
    function setupMobileTouchEnhancements() {
        // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄ
        if (touchState.isInitialized) {
            console.log('Î™®Î∞îÏùº ÌÑ∞Ïπò Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎê®');
            return;
        }
        
        // ÌïÑÏàò ÏùòÏ°¥ÏÑ± ÌôïÏù∏ Î∞è Ï†ïÏùò
        ensureDependencies();
        
        // Ï¥àÍ∏∞ ÏÑ§Ï†ï
        addTouchEvents();
        setupRenderStepHook();
        addCleanupListeners();
        
        touchState.isInitialized = true;
        console.log('Î™®Î∞îÏùº ÌÑ∞Ïπò ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    }
    
    function ensureDependencies() {
        // getCurrentEmotionLocation Ìï®Ïàò Ï†ïÏùò
        if (typeof window.getCurrentEmotionLocation !== 'function') {
            window.getCurrentEmotionLocation = function(emotion) {
                if (typeof appState === 'undefined' || !appState.quadrantEmotions) {
                    console.warn('appState.quadrantEmotionsÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                    return 'source';
                }
                
                try {
                    for (const [quadrant, emotions] of Object.entries(appState.quadrantEmotions)) {
                        if (emotions && emotions.find(e => {
                            if (!e || !emotion) return false;
                            
                            // Îã§ÏñëÌïú ÌòïÌÉúÏùò Ïù¥Î¶Ñ ÎπÑÍµê
                            const eName = e.name?.ko || e.name || '';
                            const emotionName = emotion.name?.ko || emotion.name || '';
                            
                            return eName === emotionName;
                        })) {
                            return quadrant;
                        }
                    }
                } catch (error) {
                    console.error('getCurrentEmotionLocation Ïò§Î•ò:', error);
                }
                return 'source';
            };
        }
        
        // removeEmotionFromAllLocations Ìï®Ïàò Ï†ïÏùò
        if (typeof window.removeEmotionFromAllLocations !== 'function') {
            window.removeEmotionFromAllLocations = function(emotion) {
                if (typeof appState === 'undefined' || !appState.quadrantEmotions) {
                    console.warn('appState.quadrantEmotionsÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                    return;
                }
                
                try {
                    Object.keys(appState.quadrantEmotions).forEach(key => {
                        if (appState.quadrantEmotions[key]) {
                            appState.quadrantEmotions[key] = appState.quadrantEmotions[key].filter(e => {
                                if (!e || !emotion) return true;
                                
                                const eName = e.name?.ko || e.name || '';
                                const emotionName = emotion.name?.ko || emotion.name || '';
                                
                                return eName !== emotionName;
                            });
                        }
                    });
                } catch (error) {
                    console.error('removeEmotionFromAllLocations Ïò§Î•ò:', error);
                }
            };
        }
        
        // moveEmotionToSource Ìï®Ïàò Ï†ïÏùò
        if (typeof window.moveEmotionToSource !== 'function') {
            window.moveEmotionToSource = function(emotion) {
                try {
                    window.removeEmotionFromAllLocations(emotion);
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§ ÏïàÏ†ÑÌïòÍ≤å Ìò∏Ï∂ú
                    setTimeout(() => {
                        if (typeof renderStep === 'function') renderStep();
                        if (typeof updateUI === 'function') updateUI();
                        if (typeof saveToStorage === 'function') saveToStorage();
                    }, 0);
                } catch (error) {
                    console.error('moveEmotionToSource Ïò§Î•ò:', error);
                }
            };
        }
        
        // showToast Ìï®Ïàò Ï†ïÏùò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        if (typeof window.showToast !== 'function') {
            window.showToast = function(message) {
                try {
                    // Í∏∞Ï°¥ ÌÜ†Ïä§Ìä∏ Ï†úÍ±∞
                    document.querySelectorAll('.custom-toast').forEach(t => {
                        t.remove();
                    });
                    
                    const toast = document.createElement('div');
                    toast.className = 'custom-toast fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm max-w-xs';
                    toast.style.cssText = `
                        animation: fadeInRight 0.3s ease-out;
                        pointer-events: none;
                        word-break: keep-all;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    `;
                    toast.textContent = message;
                    
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.style.animation = 'fadeOutRight 0.3s ease-out';
                            setTimeout(() => {
                                if (toast.parentNode) {
                                    toast.remove();
                                }
                            }, 300);
                        }
                    }, 2000);
                } catch (error) {
                    console.error('showToast Ïò§Î•ò:', error);
                }
            };
        }
        
        // playSound Ìï®Ïàò Ï†ïÏùò
        if (typeof window.playSound !== 'function') {
            window.playSound = function(soundType) {
                try {
                    if (typeof appState !== 'undefined' && appState.soundEnabled) {
                        console.log(`Playing sound: ${soundType}`);
                        // Ïã§Ï†ú ÏÇ¨Ïö¥Îìú Ïû¨ÏÉùÏùÄ ÏõêÎ≥∏ Ïï±Ïùò sounds Í∞ùÏ≤¥ ÏÇ¨Ïö©
                        if (typeof sounds !== 'undefined' && sounds[soundType]) {
                            sounds[soundType].play().catch(() => {});
                        }
                    }
                } catch (error) {
                    console.error('playSound Ïò§Î•ò:', error);
                }
            };
        }
    }
    
    function addTouchEvents() {
        const emotionChips = document.querySelectorAll('.emotion-chip');
        
        emotionChips.forEach(chip => {
            // Í∏∞Ï°¥ Ìï∏Îì§Îü¨ Ï†úÍ±∞
            const existingHandlers = touchState.handlers.get(chip);
            if (existingHandlers) {
                chip.removeEventListener('touchstart', existingHandlers.start);
                chip.removeEventListener('touchend', existingHandlers.end);
                chip.removeEventListener('touchmove', existingHandlers.move);
            }
            
            // ÏÉà Ìï∏Îì§Îü¨ ÏÉùÏÑ± (ÌÅ¥Î°úÏ†ÄÎ°ú chip Ï∞∏Ï°∞ ÏïàÏ†ÑÌïòÍ≤å Î≥¥Ï°¥)
            const handlers = createTouchHandlers(chip);
            
            // Ìï∏Îì§Îü¨ Ï†ÄÏû•
            touchState.handlers.set(chip, handlers);
            
            // Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            chip.addEventListener('touchstart', handlers.start, { passive: false });
            chip.addEventListener('touchend', handlers.end, { passive: false });
            chip.addEventListener('touchmove', handlers.move, { passive: false });
        });
    }
    
    function createTouchHandlers(chip) {
        // Í∞Å Ïπ©Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏù∏ ÏÉÅÌÉú Í¥ÄÎ¶¨
        let chipState = {
            longPressTimer: null,
            touchStartTime: 0,
            touchStartPos: null
        };
        
        return {
            start: function(e) {
                try {
                    if (!e.touches || e.touches.length === 0) {
                        console.warn('ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏Ïóê touches Î∞∞Ïó¥Ïù¥ ÏóÜÏùå');
                        return;
                    }
                    
                    // Ïù¥Ï†Ñ ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
                    if (chipState.longPressTimer) {
                        clearTimeout(chipState.longPressTimer);
                        chipState.longPressTimer = null;
                    }
                    
                    // ÌÑ∞Ïπò ÏãúÏûë Ï†ïÎ≥¥ Ï†ÄÏû•
                    chipState.touchStartTime = Date.now();
                    chipState.touchStartPos = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                    
                    // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Í∞êÏßÄ ÏãúÏûë
                    chipState.longPressTimer = setTimeout(() => {
                        // DOMÏóêÏÑú Ï†úÍ±∞ÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
                        if (chip.isConnected) {
                            handleLongPress(chip);
                        }
                        chipState.longPressTimer = null;
                    }, 500);
                    
                    // ÏÑ†ÌÉù Ìö®Í≥º
                    chip.classList.add('touch-pressed');
                    
                } catch (error) {
                    console.error('Touch start Ïò§Î•ò:', error);
                }
            },
            
            move: function(e) {
                try {
                    // ÏõÄÏßÅÏûÑÏù¥ Í∞êÏßÄÎêòÎ©¥ Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ï∑®ÏÜå
                    if (chipState.longPressTimer && chipState.touchStartPos) {
                        const currentPos = {
                            x: e.touches[0]?.clientX || 0,
                            y: e.touches[0]?.clientY || 0
                        };
                        
                        const distance = Math.sqrt(
                            Math.pow(currentPos.x - chipState.touchStartPos.x, 2) +
                            Math.pow(currentPos.y - chipState.touchStartPos.y, 2)
                        );
                        
                        // 10px Ïù¥ÏÉÅ ÏõÄÏßÅÏù¥Î©¥ Ï∑®ÏÜå
                        if (distance > 10) {
                            clearTimeout(chipState.longPressTimer);
                            chipState.longPressTimer = null;
                        }
                    }
                } catch (error) {
                    console.error('Touch move Ïò§Î•ò:', error);
                }
            },
            
            end: function(e) {
                try {
                    // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
                    if (chipState.longPressTimer) {
                        clearTimeout(chipState.longPressTimer);
                        chipState.longPressTimer = null;
                        
                        // ÏßßÏùÄ ÌÉ≠Ïù∏ÏßÄ ÌôïÏù∏ (500ms ÎØ∏Îßå)
                        const touchDuration = Date.now() - chipState.touchStartTime;
                        if (touchDuration < 500 && chip.isConnected) {
                            handleShortTap(chip);
                        }
                    }
                    
                    // ÏÑ†ÌÉù Ìö®Í≥º Ï†úÍ±∞
                    chip.classList.remove('touch-pressed');
                    
                    // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                    chipState.touchStartTime = 0;
                    chipState.touchStartPos = null;
                    
                } catch (error) {
                    console.error('Touch end Ïò§Î•ò:', error);
                }
            }
        };
    }
    
    function handleLongPress(chip) {
        try {
            showMobileContextMenu(chip);
            
            // ÌñÖÌã± ÌîºÎìúÎ∞±
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        } catch (error) {
            console.error('Long press Ï≤òÎ¶¨ Ïò§Î•ò:', error);
        }
    }
    
    function handleShortTap(chip) {
        try {
            if (!touchState.selectedEmotion) {
                selectEmotionForMove(chip);
            } else if (touchState.selectedEmotion === chip) {
                deselectEmotion();
            } else {
                // Îã§Î•∏ Í∞êÏ†ïÏπ¥Îìú ÌÉ≠ = ÏúÑÏπò ÍµêÌôò
                swapEmotions(touchState.selectedEmotion, chip);
            }
        } catch (error) {
            console.error('Short tap Ï≤òÎ¶¨ Ïò§Î•ò:', error);
        }
    }
    
    function selectEmotionForMove(chip) {
        try {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
            deselectEmotion();
            
            // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
            touchState.selectedEmotion = chip;
            chip.classList.add('selected-for-move');
            
            // ÌÉÄÍ≤ü ÏòÅÏó≠Îì§ ÌôúÏÑ±Ìôî
            activateTargetAreas();
            
            window.showToast('Ïù¥ÎèôÌï† ÏúÑÏπòÎ•º ÌÉ≠ÌïòÏÑ∏Ïöî (Îã§Ïãú ÌÉ≠ÌïòÎ©¥ Ï∑®ÏÜå)');
            
            // ÏûêÎèô Ï∑®ÏÜå (10Ï¥à ÌõÑ)
            setTimeout(() => {
                if (touchState.selectedEmotion === chip) {
                    deselectEmotion();
                }
            }, 10000);
            
        } catch (error) {
            console.error('selectEmotionForMove Ïò§Î•ò:', error);
            deselectEmotion();
        }
    }
    
    function activateTargetAreas() {
        // 4Î∂ÑÎ©¥Îì§ÏùÑ ÌïòÏù¥ÎùºÏù¥Ìä∏
        document.querySelectorAll('.quadrant').forEach(quadrant => {
            quadrant.classList.add('move-target');
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Í¥ÄÎ¶¨
            if (!quadrant._touchMoveHandler) {
                quadrant._touchMoveHandler = (e) => handleQuadrantTap(e);
                quadrant.addEventListener('click', quadrant._touchMoveHandler);
            }
        });
        
        // ÏÜåÏä§ ÏòÅÏó≠ÎèÑ ÌôúÏÑ±Ìôî
        const sourceArea = document.getElementById('emotionSource');
        if (sourceArea) {
            sourceArea.classList.add('move-target');
            
            if (!sourceArea._touchMoveHandler) {
                sourceArea._touchMoveHandler = (e) => handleSourceTap(e);
                sourceArea.addEventListener('click', sourceArea._touchMoveHandler);
            }
        }
    }
    
    function deselectEmotion() {
        try {
            if (touchState.selectedEmotion) {
                touchState.selectedEmotion.classList.remove('selected-for-move');
                touchState.selectedEmotion = null;
            }
            
            // Î™®Îì† ÌÉÄÍ≤ü ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.move-target').forEach(target => {
                target.classList.remove('move-target');
                
                if (target._touchMoveHandler) {
                    target.removeEventListener('click', target._touchMoveHandler);
                    target._touchMoveHandler = null;
                }
            });
        } catch (error) {
            console.error('deselectEmotion Ïò§Î•ò:', error);
        }
    }
    
    function handleQuadrantTap(e) {
        if (!touchState.selectedEmotion) return;
        
        try {
            e.stopPropagation();
            const quadrant = e.currentTarget.dataset.quadrant;
            const emotionData = getEmotionData(touchState.selectedEmotion);
            
            if (emotionData && quadrant) {
                const emotion = JSON.parse(emotionData);
                moveEmotionToQuadrant(emotion, quadrant);
                deselectEmotion();
            }
        } catch (error) {
            console.error('handleQuadrantTap Ïò§Î•ò:', error);
            deselectEmotion();
        }
    }
    
    function handleSourceTap(e) {
        if (!touchState.selectedEmotion) return;
        
        try {
            e.stopPropagation();
            const emotionData = getEmotionData(touchState.selectedEmotion);
            
            if (emotionData) {
                const emotion = JSON.parse(emotionData);
                window.moveEmotionToSource(emotion);
                deselectEmotion();
            }
        } catch (error) {
            console.error('handleSourceTap Ïò§Î•ò:', error);
            deselectEmotion();
        }
    }
    
    function getEmotionData(element) {
        return element.dataset.emotion || 
               element.closest('[data-emotion]')?.dataset.emotion;
    }
    
    function swapEmotions(chip1, chip2) {
        try {
            const emotion1Data = getEmotionData(chip1);
            const emotion2Data = getEmotionData(chip2);
            
            if (!emotion1Data || !emotion2Data) {
                console.warn('Í∞êÏ†ï Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            
            const emotion1 = JSON.parse(emotion1Data);
            const emotion2 = JSON.parse(emotion2Data);
            
            const location1 = window.getCurrentEmotionLocation(emotion1);
            const location2 = window.getCurrentEmotionLocation(emotion2);
            
            // Îëê Í∞êÏ†ïÏùò ÏúÑÏπò ÍµêÌôò
            window.removeEmotionFromAllLocations(emotion1);
            window.removeEmotionFromAllLocations(emotion2);
            
            if (location1 !== 'source' && typeof appState !== 'undefined' && appState.quadrantEmotions) {
                appState.quadrantEmotions[location1].push(emotion2);
            }
            if (location2 !== 'source' && typeof appState !== 'undefined' && appState.quadrantEmotions) {
                appState.quadrantEmotions[location2].push(emotion1);
            }
            
            window.showToast('Í∞êÏ†ïÏπ¥Îìú ÏúÑÏπòÍ∞Ä ÍµêÌôòÎêòÏóàÏñ¥Ïöî!');
            window.playSound('success');
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏ (ÎπÑÎèôÍ∏∞Î°ú Ï≤òÎ¶¨)
            setTimeout(() => {
                if (typeof renderStep === 'function') renderStep();
                if (typeof updateUI === 'function') updateUI();
                if (typeof saveToStorage === 'function') saveToStorage();
            }, 0);
            
            deselectEmotion();
            
        } catch (error) {
            console.error('swapEmotions Ïò§Î•ò:', error);
            deselectEmotion();
        }
    }
    
    function showMobileContextMenu(chip) {
        try {
            const emotionData = getEmotionData(chip);
            if (!emotionData) {
                console.warn('Í∞êÏ†ï Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            
            const emotion = JSON.parse(emotionData);
            const menu = createMobileMenu(emotion);
            
            // Í∏∞Ï°¥ Î©îÎâ¥ Ï†úÍ±∞
            document.querySelectorAll('.mobile-context-menu, .mobile-menu-overlay').forEach(m => m.remove());
            
            // Î©îÎâ¥ ÌëúÏãú
            document.body.appendChild(menu);
            
            // Î∞∞Í≤Ω Ïò§Î≤ÑÎ†àÏù¥ Ï∂îÍ∞Ä
            const overlay = createOverlay(() => {
                menu.remove();
                overlay.remove();
            });
            
            document.body.appendChild(overlay);
            
        } catch (error) {
            console.error('showMobileContextMenu Ïò§Î•ò:', error);
        }
    }
    
    function createMobileMenu(emotion) {
        const menu = document.createElement('div');
        menu.className = 'mobile-context-menu fixed bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4';
        menu.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            animation: mobileMenuSlideUp 0.3s ease-out;
        `;
        
        // ÏïàÏ†ÑÌïú Ïñ∏Ïñ¥ Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º
        const language = (typeof appState !== 'undefined' && appState.language) ? appState.language : 'ko';
        const currentLocation = window.getCurrentEmotionLocation(emotion);
        const emotionName = emotion.name?.[language] || emotion.name || 'Ïïå Ïàò ÏóÜÎäî Í∞êÏ†ï';
        const emotionDescription = emotion.description?.[language] || emotion.description || '';
        
        menu.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">${emotion.emoji || 'üòê'}</div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">
                    ${emotionName}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    ${emotionDescription}
                </p>
            </div>
            
            <div class="space-y-3">
                ${currentLocation !== 'source' ? `
                    <button class="move-to-source-btn w-full py-3 px-4 bg-blue-500 text-white rounded-xl flex items-center justify-center space-x-2 text-sm font-medium">
                        <span>üîÑ</span>
                        <span>Î∂ÑÎ•òÌï®ÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞</span>
                    </button>
                ` : ''}
                
                <div class="text-xs text-gray-500 dark:text-gray-400 text-center">Îã§Î•∏ Î∂ÑÎ©¥ÏúºÎ°ú Ïù¥Îèô</div>
                
                <div class="grid grid-cols-2 gap-3 quadrant-buttons">
                    <!-- 4Î∂ÑÎ©¥ Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
                
                <button class="close-menu-btn w-full py-3 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-xl text-sm font-medium">
                    Ï∑®ÏÜå
                </button>
            </div>
        `;
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏßÅÏ†ë Ï∂îÍ∞Ä (onclick ÎåÄÏã†)
        setupMenuEventListeners(menu, emotion, currentLocation, language);
        
        return menu;
    }
    
    function setupMenuEventListeners(menu, emotion, currentLocation, language) {
        // Î∂ÑÎ•òÌï®ÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞ Î≤ÑÌäº
        const sourceBtn = menu.querySelector('.move-to-source-btn');
        if (sourceBtn) {
            sourceBtn.addEventListener('click', () => {
                window.moveEmotionToSource(emotion);
                closeAllMenus();
            });
        }
        
        // 4Î∂ÑÎ©¥ Î≤ÑÌäºÎì§ Ï∂îÍ∞Ä
        const quadrantContainer = menu.querySelector('.quadrant-buttons');
        if (typeof quadrantInfo !== 'undefined' && quadrantContainer) {
            Object.keys(quadrantInfo).forEach(quadrant => {
                if (currentLocation === quadrant) return;
                
                const info = quadrantInfo[quadrant];
                const titleParts = info.title[language].split(' ');
                
                const button = document.createElement('button');
                button.className = `py-3 px-2 ${info.color} border-2 border-gray-200 rounded-xl text-xs font-medium text-center`;
                button.innerHTML = `
                    <div class="text-lg mb-1">${titleParts[0] || ''}</div>
                    <div>${titleParts[1] || ''}</div>
                `;
                
                button.addEventListener('click', () => {
                    moveEmotionToQuadrant(emotion, quadrant);
                    closeAllMenus();
                });
                
                quadrantContainer.appendChild(button);
            });
        }
        
        // Ï∑®ÏÜå Î≤ÑÌäº
        const closeBtn = menu.querySelector('.close-menu-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeAllMenus);
        }
    }
    
    function createOverlay(onClick) {
        const overlay = document.createElement('div');
        overlay.className = 'mobile-menu-overlay fixed inset-0 bg-black bg-opacity-50';
        overlay.style.cssText = `
            z-index: 999;
            animation: fadeIn 0.3s ease-out;
        `;
        overlay.addEventListener('click', onClick);
        return overlay;
    }
    
    function closeAllMenus() {
        document.querySelectorAll('.mobile-context-menu, .mobile-menu-overlay').forEach(el => el.remove());
    }
    
    function moveEmotionToQuadrant(emotion, quadrant) {
        try {
            // ÏïàÏ†ÑÏÑ± Ï≤¥ÌÅ¨
            if (typeof appState === 'undefined' || !appState.quadrantEmotions) {
                console.error('appState.quadrantEmotionsÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                return;
            }
            
            if (typeof quadrantInfo === 'undefined' || !quadrantInfo[quadrant]) {
                console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ quadrant:', quadrant);
                return;
            }
            
            // Î™®Îì† ÏúÑÏπòÏóêÏÑú Ï†úÍ±∞
            window.removeEmotionFromAllLocations(emotion);
            
            // ÏÉà ÏúÑÏπòÏóê Ï∂îÍ∞Ä
            appState.quadrantEmotions[quadrant].push(emotion);
            
            // ÏïàÏ†ÑÌïú Ïñ∏Ïñ¥ Ï†ëÍ∑º
            const language = appState.language || 'ko';
            const quadrantName = quadrantInfo[quadrant].title[language];
            const emotionName = emotion.name?.[language] || emotion.name || 'Í∞êÏ†ï';
            
            window.showToast(`"${emotionName}"Ïù¥(Í∞Ä) ${quadrantName}Î°ú Ïù¥ÎèôÌñàÏñ¥Ïöî!`);
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏ (ÎπÑÎèôÍ∏∞Î°ú Ï≤òÎ¶¨)
            setTimeout(() => {
                if (typeof renderStep === 'function') renderStep();
                if (typeof updateUI === 'function') updateUI();
                if (typeof saveToStorage === 'function') saveToStorage();
            }, 0);
            
            window.playSound('success');
            
        } catch (error) {
            console.error('moveEmotionToQuadrant Ïò§Î•ò:', error);
        }
    }
    
    function setupRenderStepHook() {
        // renderStep ÌõÑÌÇπ (Ï§ëÎ≥µ Î∞©ÏßÄ)
        if (typeof window.renderStep === 'function' && !window.renderStep._touchHooked) {
            const originalRenderStep = window.renderStep;
            
            window.renderStep = function() {
                try {
                    originalRenderStep.apply(this, arguments);
                } catch (error) {
                    console.error('Original renderStep Ïò§Î•ò:', error);
                } finally {
                    // UI ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ïû¨ÏÑ§Ï†ï
                    setTimeout(() => {
                        if (touchState.isInitialized) {
                            addTouchEvents();
                        }
                    }, 100);
                }
            };
            
            window.renderStep._touchHooked = true;
        }
    }
    
    function addCleanupListeners() {
        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', cleanup);
        
        // visibility change Ïãú Ï†ïÎ¶¨
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                cleanup();
            }
        });
    }
    
    function cleanup() {
        try {
            // Î™®Îì† ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (touchState.longPressTimer) {
                clearTimeout(touchState.longPressTimer);
                touchState.longPressTimer = null;
            }
            
            // ÏÑ†ÌÉù ÏÉÅÌÉú Ï†ïÎ¶¨
            deselectEmotion();
            
            // Î™®Îì† Î©îÎâ¥ Ï†úÍ±∞
            closeAllMenus();
            
            console.log('Î™®Î∞îÏùº ÌÑ∞Ïπò Ï†ïÎ¶¨ ÏôÑÎ£å');
        } catch (error) {
            console.error('Cleanup Ïò§Î•ò:', error);
        }
    }
    
    // Ï†ÑÏó≠ Ìï®ÏàòÎì§ Îì±Î°ù
    window.mobileMenuAction = function(target, emotionJson) {
        try {
            const emotion = JSON.parse(decodeURIComponent(emotionJson));
            
            if (target === 'source') {
                window.moveEmotionToSource(emotion);
            } else {
                moveEmotionToQuadrant(emotion, target);
            }
            
            closeAllMenus();
        } catch (error) {
            console.error('mobileMenuAction Ïò§Î•ò:', error);
            closeAllMenus();
        }
    };
    
    window.closeMobileMenu = closeAllMenus;
    
    window.cleanupMobileTouchEvents = cleanup;
    
    // CSS Ï∂îÍ∞Ä (Ï§ëÎ≥µ Î∞©ÏßÄ)
    if (!document.querySelector('#mobile-touch-styles')) {
        const style = document.createElement('style');
        style.id = 'mobile-touch-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeInRight {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes fadeOutRight {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(20px); }
            }
            
            .touch-pressed {
                transform: scale(0.95);
                opacity: 0.8;
                transition: all 0.1s ease;
            }
            
            .selected-for-move {
                border: 2px solid #3b82f6 !important;
                background: rgba(59, 130, 246, 0.1) !important;
                animation: pulse-select 1.5s infinite;
            }
            
            @keyframes pulse-select {
                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            }
            
            .move-target {
                border: 2px dashed #10b981 !important;
                background: rgba(16, 185, 129, 0.1) !important;
                cursor: pointer;
                animation: move-target-pulse 1s infinite;
            }
            
            @keyframes move-target-pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            .mobile-context-menu {
                animation: mobileMenuSlideUp 0.3s ease-out;
            }
            
            @keyframes mobileMenuSlideUp {
                from { 
                    opacity: 0; 
                    transform: translate(-50%, -50%) scale(0.9); 
                }
                to { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1); 
                }
            }
            
            /* ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú Ìò∏Î≤Ñ Ìö®Í≥º ÎπÑÌôúÏÑ±Ìôî */
            @media (hover: none) {
                .emotion-chip:hover {
                    transform: none;
                }
            }
            
            /* ÌÑ∞Ïπò ÌÉÄÍ≤ü ÌÅ¨Í∏∞ ÌôïÎ≥¥ */
            @media (max-width: 640px) {
                .emotion-chip {
                    min-height: 44px;
                    min-width: 44px;
                    padding: 8px 12px;
                    font-size: 14px;
                }
                
                .quadrant {
                    min-height: 150px;
                    padding: 16px;
                }
            }
            
            .custom-toast {
                pointer-events: none;
                user-select: none;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Ï¥àÍ∏∞Ìôî Ìï®Ïàò Ìò∏Ï∂ú
    setupMobileTouchEnhancements();
    
})();
